/*global
ADF,
_
*/
ADF.config = {
    messages : {
        levels : {
            'log' : {
                'displayMethod' : 'none',
                'label' : 'Log Entry'
            },
            'info' : {
                'displayMethod' : 'console',
                'label' : 'Info'
            },
            'debug' : {
                'displayMethod' : 'console',
                'label' : 'Debug Info'
            },
            'warn' : {
                'displayMethod' : 'console',
                'label' : 'Warning'
            },
            'error' : {
                'displayMethod' : 'messagesWindow',
                'label' : 'Error'
            }
        }
    },
    set: function( itemName, value ){
        if( Object.prototype.toString.call( value ) === '[object Object]' ) {
            localStorage.setItem(itemName, JSON.stringify(value));
        }else{
            localStorage.setItem(itemName, value);
        }
    },
    get: function( itemName ){

        var configItem;

        if(!localStorage.getItem(itemName)) {
            configItem = ADF.config[itemName];
        }else{
            configItem = localStorage.getItem(itemName);
            if( _.isObject( configItem ) === '[object Object]') {
                configItem = JSON.parse( configItem );
            }
        }

        return configItem;

    }
};
/*global
ADF,
_,
$,
adf
*/
ADF.utils = {
    randomId: function() {
        return Math.floor( Math.random() * 3789.4);
    },
    capitalize: function( string ) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    },
    camelize: function( string ) {
        return string.toLowerCase().replace(/[_.-](\w|$)/g, function (_,x) {
            return x.toUpperCase();
        });
    },
    isObject: function( obj ) {
        return Object.prototype.toString.call( obj ) === '[object Object]';
    },
    arrayToHTML: function( array, parentElement, childElement ) {
        var retElement = document.createElement(parentElement);
        _.each( array, function(item) {
            var child = document.createElement(childElement);
            if( ADF.utils.isObject( item ) ){
                // TODO: handle an item of the array being an object
                child.appendChild(document.createTextNode(item));
            }else{
                child.appendChild(document.createTextNode(item));
            }
            retElement.appendChild(child);
        });
        return retElement.innerHTML;
    },
    objPropToLower: function( object ) {

        _.each(object,function(element, index, array){
            // console.log(element);
            if( index.toLowerCase() !== index ){
                object[index.toLowerCase()] = element;
                delete object[index];
            }
        });

        return object;

    },
    select2: {
        render: function() {

            // TODO dynamically determine if user can clear selection
            // TODO dynamically determine if user cna add new option

            var settings = {
                dropdownAutoWidth : true,
                allowClear : true,
                formatResult : ADF.utils.select2.template,
                matcher: ADF.utils.select2.matcher
            };

            $.extend( settings, arguments[0] );

            var select2Obj = settings.select2Obj;

            delete settings.select2Obj;

            select2Obj.select2(settings);

            if( select2Obj.attr('readonly') === 'readonly' ){
                select2Obj.select2('readonly',true);
            }

        },
        matcher: function(term, text, option) {
            return text.toUpperCase().indexOf(term.toUpperCase())>=0 || option.val().toUpperCase().indexOf(term.toUpperCase())>=0;
        },
        template: function( object, container, query ){

            //make this into a jQ object so we can retrieve the data- attribute data
            var optObj = $(object.element);
            var entryObj = {
                value: object.id,
                tooltip: optObj.data('tooltip')
            };

            //have to do some manual stuff to "convert" this object that we get
            //into a normal js object that can be used in hour handlebars template
            //rather than just a plain old js-built template
            if( object.id === object.text || object.text.length === 0 ){
                entryObj.label = object.id;
            }else{
                entryObj.label = '<span class="select2-option-value">'+object.id+'</span><span class="select2-option-label">'+object.text+'</span>';
            }
            return ADF.templates.inputHelperSelect2Record( entryObj );

        },
        refresh: function() {

            $('body .select2:input').not('.select2-offscreen').each(function(){
                ADF.utils.select2.render({
                    select2Obj : $(this)
                });
            });

        }
    },
    spin: function( targetObj, opts ) {

        var settings = {};
        var defaults = {
            emptyTarget : false
        };

        $.extend(settings, defaults, opts);

        if( settings.stop ){

            targetObj.removeClass('loading').find('.spinner').remove();

        }else{

            targetObj.removeClass('hide');

            if( settings.emptyTarget ){
                targetObj.empty();
            }

            targetObj.addClass('loading').spin();

        }

    },
    message: function() {

        // TODO: log all messages into "level" specific arrays
        // TODO: somehow know when there is a line number and file reference so the message in the messagesWindow could be a link

        // var args = Array.slice(arguments);
        var args = Array.prototype.slice.call(arguments);

        // remove first argument
        var level = args.shift().toLowerCase();

        if( ADF.config.get('messages').levels[level] ){

            var levelObj = ADF.config.get('messages').levels[level];

            // TODO: extend this to present errors as modals
            switch( levelObj.displayMethod ){
                case 'messagesWindow':
                    // TODO: handle errors somehow before the adf and adf.page are defined
                    // since we might have an error before the page loads up we'll do this for a bit to see if we can get into the messages window
                    if( adf.page && adf.page.getRegion('messagesWindow') ){
                        adf.page.getRegion('messagesWindow').messagesWindowView.collection.add([
                            {
                                level: level,
                                label: levelObj.label,
                                originalArguments: args
                            }
                        ]);
                        adf.page.getRegion('messagesWindow').show();
                    }else{
                        args.unshift('[ADF]');
                        console[level](args);
                    }
                    break;
                case 'console':
                    // since we are just logging it we add a prefix item to the logs just to try and be clear where it came from
                    args.unshift('[ADF]');
                    console[level](args);
                    break;

            }

        }else{
            alert('unexpected level'+ADF.utils.printObject(args));
        }

    },

    printObject: function(obj){
        return JSON.stringify(obj,null,'\t').replace(/\n/g,'<br>').replace(/\t/g,'&nbsp;&nbsp;&nbsp;');
    },

};
/*global
Backbone,
Marionette,
$
*/
// TODO: svg rendering
Backbone.emulateHTTP = true;
var ADF = ADF||{};
ADF.App = Marionette.Application.extend({
  initialize: function(options) {
     ADF.utils.message('log','App Initialized', options);
  }
});

var adf = new ADF.App({container: 'body'});
adf.on('start', function(options){
    $.ajaxSetup({
        dataType: 'json',
        contentType: 'application/json'
    });
    adf.page = new ADF.PageLayoutView({el:'.adf-page'});
});

window.onerror = function( message, file, lineNumber ) {
    ADF.utils.message('error',message,file,lineNumber);
    return true;
};
/*global
ADF,
Backbone,
$,
_
*/
ADF.PageLayoutView = Backbone.Marionette.LayoutView.extend({
    events: {
        'click .overlay-close'          : 'closeOverlayEditor'
    },
    initialize: function( options ) {
        ADF.utils.message('log','PageLayoutView Initialized', options);
        var pageView = this;
        pageView.dndSources = [];
        pageView.dndTargets = [];

        pageView.listenTo(pageView,'regionsInitialized',function(){
            // TODO: remove this bullshit
            setTimeout(function(){
                pageView.showRegions();
            },1);
        });

        pageView.initRegions();

        this._super( options );
    },
    initRegions: function(){
        var pageView = this;
        var regions = {};
        // make sure there is a messages window on the page
        this._initMessagesWindow();
        pageView.$el.find('.adf-region').each(function(){
            var region = $(this);
            var regionData = region.data();

            // skip regions that maybe are malformed or missing the region type
            if( regionData.adfRegionType ){

                regionData.regionClass = ADF.utils.capitalize(ADF.utils.camelize(regionData.adfRegionType))+'Region';
                regionData.elSelector = '#'+$(this).attr('id');
                regionData.regionName = ADF.utils.camelize($(this).attr('id'));

                if( !ADF[regionData.regionClass]){
                    ADF.utils.message('error','unexpected region class',regionData.regionClass);
                    return true;
                }

                // create the region
                regions[regionData.regionName] = new ADF[regionData.regionClass](_.extend({el: regionData.elSelector},regionData));
                pageView.addRegions(regions);

            }
        },pageView.trigger('regionsInitialized'));
    },
    showRegions: function() {
        _.each(this.getRegions(),function(region){
            if( !region.inert ){
                region.show();
            }
        });
    },
    findRegion: function( filter ) {
        var regions = this.getRegions();
        return _.find(regions,function(region){
            return region[filter.attribute] === filter.value || region.options[filter.attribute] === filter.value;
        });
    },
    showBackdrop: function() {
        $('.backdrop').removeClass('hide');
    },
    hideBackdrop: function() {
        $('.backdrop').addClass('hide');
    },
    closeOverlayEditor: function(e) {
        e.preventDefault();
        this.getRegion('overlayEditor').hide();
    },
    _initMessagesWindow: function() {
        var pageView = this;
        if( pageView.$el.find('.adf-messages-window').size() === 0 ){
            pageView.$el.append(ADF.templates.messagesWindow());
        }
    }

});
/*global
ADF,
Marionette,
_,
$
*/
ADF.Region = Marionette.Region.extend({
    // TODO: create new region for an overlay
    // TODO: overlay region optionally can get data from caller region

    initialize: function(options){
        ADF.utils.message('log','Region Initialized',options);
        this.adfAjaxOnshow = ( options.adfAjaxOnshow ? options.adfAjaxOnshow : false );
    },
    show: function() {
        // TODO: this really shouldn't be in the region object, probably part of the view that we've associated with it...
        if( this.adfAjaxOnshow ){
            this.ajax();
        }
    },
    ajax: function( options ){
        var region = this;
        var settings = _.extend({data:JSON.stringify(region.options.adfAjaxData)}, options);

        ADF.utils.message('log','Ajax Call',options,settings);

        $.ajax({
            url: ( settings.url ? settings.url : region.options.adfAjaxUrl ),
            type: ( settings.method ? settings.method : 'POST' ),
            data: settings.data,
            beforeSend: function(){
                ADF.utils.spin(region.$el);
            },
            complete: function( jqXHR, textStatus ){

                ADF.utils.spin(region.$el, { stop: true } );

                if( jqXHR.status === 200 ){

                    if( jqXHR.responseJSON ){

                        ADF.utils.message('log','AJAX message: '+jqXHR.responseJSON.message);

                        // this is custom depending on the calling region's type so we send it back
                        region.ajaxSuccessHandler(jqXHR.responseJSON, settings);

                    }else{

                        ADF.utils.message('error','Malformed response received that does not have the expected JSON object',jqXHR,settings);

                    }

                }else if( jqXHR.status === 404 ){

                    ADF.utils.message('error','<h1>Page Not Found.</h1><p>The ajax calls is being made to a page ('+settings.url+') that could not be found. Probably going to need to get a TA involved to see what is going on here.');

                }else{

                    alert(textStatus+'! Probably going to need to get a TA involved.');
                    console.log('settings',settings);
                    console.log(jqXHR);
                    region.$el.html(jqXHR.responseText);

                }

            }
        });
    }
});

/*global
ADF,
_
*/
ADF.FormRegion = ADF.Region.extend({
    // TODO: handle being in a dialog
    // TODO: preexisting data handled

    initialize: function( options ) {
        ADF.utils.message('log','FormRegion Initialized', options);
        this._super( options );
    },

    show: function() {

        var formRegion = this;

        formRegion.formView = new ADF.FormView({
            el:formRegion.$el.find('form')[0],
            collection: new ADF.FieldsCollection(),
            regionName: formRegion.options.regionName
        });

        formRegion.actionsCollection = new ADF.ActionsCollection(null,{regionName: formRegion.options.regionName});

        this._super();

    },

    ajaxSuccessHandler: function( xhrJson, settings ) {

        var formRegion = this;
        var formView = formRegion.formView;

        if( xhrJson.success === true ){

            if( xhrJson.data.hasOwnProperty('actions') ){

                if( settings.emptyCollections === false ){
                    formRegion.actionsCollection.add(xhrJson.data.actions);
                }else{
                    formRegion.actionsCollection.reset(xhrJson.data.actions);
                }

            }

            if( xhrJson.data.hasOwnProperty('fields') ){

                if( settings.emptyCollections === false ){
                    formView.collection.add(xhrJson.data.fields);
                }else{
                    formView.collection.reset(xhrJson.data.fields);
                }


                // TODO: add select2 renderer as part of the auto-rendering of the Marionette view

                // manually call render for some reason
                // thought that Marionette handled this for us but it wasn't firing so this had to be added
                formView.render();

            }

        }else{

            if( xhrJson.hasOwnProperty('errors') ){
                _.each(xhrJson.errors,function( element, index, array ){
                    alert(element);
                });
            }else{
                alert('Looks like the ajax response wasn\'t quite what was expected.  Probably need to get a TA involved to help figure it out.');
            }

        }

    }

});
/*global
ADF,
_
*/
ADF.GridRegion = ADF.Region.extend({
    template: ADF.templates.gridWrapper,
    initialize: function( options ) {

        ADF.utils.message('log','GridRegion Initialized', options);

        var gridRegion = this;

        if( gridRegion.$el.hasClass('adf-grid-overlay-editor') ){
            gridRegion.inOverlay = true;
        }else{
            gridRegion.inOverlay = false;
        }

        gridRegion.$el.html(gridRegion.template({inOverlay:gridRegion.inOverlay}));
        gridRegion.fieldsCollection = new ADF.FieldsCollection(null,{regionName:gridRegion.options.regionName});
        gridRegion.actionsCollection = new ADF.ActionsCollection(null,{regionName: gridRegion.options.regionName});

        this._super( options );


    },

    show: function() {

        ADF.utils.message('log','gridRegion Shown');

        var gridRegion = this;
        gridRegion.gridView = new ADF.GridView({
            el:gridRegion.$el.find('.adf-grid-wrapper')[0],
            collection: new ADF.RecordsCollection(null,{regionName:gridRegion.options.regionName}),
            regionName: gridRegion.options.regionName
        });

        this._super();

    },

    ajaxSuccessHandler: function( xhrJson, settings ) {

        var gridRegion = this;

        if( xhrJson.success === true ){

            if( xhrJson.data.hasOwnProperty('fields') ){

                gridRegion.fieldsCollection.reset(xhrJson.data.fields);

            }

            if( xhrJson.data.hasOwnProperty('actions') ){

                if( settings.emptyCollections === false ){
                    gridRegion.actionsCollection.add(xhrJson.data.actions);
                }else{
                    gridRegion.actionsCollection.reset(xhrJson.data.actions);
                }

            }

            if( xhrJson.data.hasOwnProperty('records') ){

                gridRegion.gridView.collection.reset(xhrJson.data.records);

                // console.log(gridRegion.gridView.children);

                // console.log(gridRegion.gridView.collection.length);

                // TODO: add select2 renderer as part of the auto-rendering of the Marionette view

                // manually call render for some reason
                // thought that Marionette handled this for us but it wasn't firing so this had to be added
                gridRegion.gridView.render();

            }


        }else{

            if( xhrJson.hasOwnProperty('errors') ){
                _.each(xhrJson.errors,function( element, index, array ){
                    alert(element);
                });
            }else{
                alert('Looks like the ajax response wasn\'t quite what was expected.  Probably need to get a TA involved to help figure it out.');
            }

        }

    }

});
/*global
ADF,
_,
$
*/
ADF.ModulesRegion = ADF.Region.extend({
    template: ADF.templates.moduleListWrapper,
    initialize: function( options ) {
        ADF.utils.message('log','ModulesRegion Initialized', options);
        var modulesRegion = this;
        modulesRegion.options = $.extend({},options,modulesRegion.$el.data());
        this._super( options );
    },

    show: function() {

        var modulesRegion = this;

        modulesRegion.$el.html(modulesRegion.template({
            dndSource:modulesRegion.options.adfDndSource,
            dndTarget:modulesRegion.options.adfDndTarget
        }));

        modulesRegion.fieldsCollection = new ADF.FieldsCollection(null,{regionName:modulesRegion.options.regionName});
        modulesRegion.actionsCollection = new ADF.ActionsCollection(null,{regionName: modulesRegion.options.regionName});

        modulesRegion.modulesView = new ADF.ModulesView({
            el:modulesRegion.$el.find('.module-list-wrapper')[0],
            collection: new ADF.RecordsCollection(),
            regionName: modulesRegion.options.regionName,
            dndSource: modulesRegion.options.adfDndSource,
            dndTarget: modulesRegion.options.adfDndTarget
        });

        this._super();

    },

    // TODO: commonize more of the ajax success handler code
    ajaxSuccessHandler: function( xhrJson, settings ) {

        var modulesRegion = this;
        var modulesView = modulesRegion.modulesView;

        if( xhrJson.success === true ){

            if( xhrJson.data.hasOwnProperty('actions') ){

                if( settings.emptyCollections === false ){
                    modulesRegion.actionsCollection.add(xhrJson.data.actions);
                }else{
                    modulesRegion.actionsCollection.reset(xhrJson.data.actions);
                }

            }

            if( xhrJson.data.hasOwnProperty('fields') ){

                if( settings.emptyCollections === false ){
                    modulesRegion.fieldsCollection.add(xhrJson.data.fields);
                }else{
                    modulesRegion.fieldsCollection.reset(xhrJson.data.fields);
                }

            }

            if( xhrJson.data.hasOwnProperty('records') ){

                if( settings.emptyCollections === false ){
                    modulesView.collection.add(xhrJson.data.records);
                }else{
                    modulesView.collection.reset(xhrJson.data.records);
                }

            }

            // manually call render for some reason
            // thought that Marionette handled this for us but it wasn't firing so this had to be added
            modulesView.render();

        }else{

            if( xhrJson.hasOwnProperty('errors') ){
                _.each(xhrJson.errors,function( element, index, array ){
                    alert(element);
                });
            }else{
                alert('Looks like the ajax response wasn\'t quite what was expected.  Probably need to get a TA involved to help figure it out.');
            }

        }

    }

});
/*global
ADF,
adf,
_
*/
ADF.OverlayGridRegion = ADF.GridRegion.extend({
    initialize: function( options ) {
        ADF.utils.message('log','OverlayGridRegion Initialized', options);

        // this just means that we don't trigger the show() method on page load
        this.inert = true;

        this._super( options );
    },

    show: function( $triggerObj ) {
        ADF.utils.message('log','OverlayGridRegion Shown');
        var triggerBox = $triggerObj[0].getBoundingClientRect();
        var triggerData = $triggerObj.data();
        var triggerOffset = $triggerObj.offset();

        // TODO: position relative to trigger field
        // TODO: check location of trigger field and possibly open up

        adf.page.showBackdrop();
        this.$el.addClass('open').css({top:( triggerOffset.top + triggerBox.height ) });
        this.options.adfAjaxUrl = triggerData.adfAjaxUrl;
        this.options.adfAjaxData = {};
        _.each(triggerData.adfAjaxDataFields.split(','), function( fieldName ){
            // TODO: get this from the backbone model rather than the DOM
            this.options.adfAjaxData[fieldName] = $triggerObj.closest('tr').find(':input[name='+fieldName+']').val();
        },this);
        this._super();
    },

    hide: function() {
        ADF.utils.message('log','OverlayGridRegion Hidden');
        // TODO: empty the region
        // TODO: remove the ajax url

        if( this.$el.find('.changed') > 0 ){
            // TODO: make this a bit prettier
            alert('found records that have been changed and not saved');
        }

        this.$el.empty().removeClass('open');
        adf.page.hideBackdrop();

    }

});
/*global
ADF,
adf
*/
ADF.MessagesWindowRegion = ADF.Region.extend({
    initialize: function( options ) {
        ADF.utils.message('log','MessageWindow Initialized', options);

        var messagesWindow = this;

        // this just means that we don't trigger the show() method on page load
        messagesWindow.inert = true;

        messagesWindow.messagesWindowView = new ADF.MessagesWindowView({
            el: messagesWindow.$el.find('.messages-wrapper')[0],
            collection: new ADF.MessagesCollection(),
            regionName: options.regionName
        });
        messagesWindow._super( options );

    },

    show: function( messageHeader, messageBody, messageFooter ) {
        // TODO: populate modal with the incoming content
        // TODO: handle the modal already being open for error things and appending to it
        // TODO: have a way to know if it's a similar message (all errors, etc) and group them
        // TODO: tabs for more than one message?
        ADF.utils.message('log','MessageWindow Shown');
        this.$el.addClass('show');
        this.messagesWindowView.render();
    },

    hide: function() {
        ADF.utils.message('log','MessageWindow Hidden');
        // TODO: empty the region
        // TODO: remove the ajax url

        this.$el.empty().removeClass('open');
        adf.page.hideBackdrop();

    }

});
/*global
ADF,
Backbone
*/
ADF.FieldModel = Backbone.Model.extend({

    initialize: function( attrs, opts  ){
        ADF.utils.message('log','FieldModel Initialized', attrs, opts);
        var fieldModel = this;

        if( attrs.name.toLowerCase() !== attrs.name ){
            fieldModel.set('name',attrs.name.toLowerCase());
        }

        // do this step-by-step for clarity and maintainability (not to mention debuggability)
        var inputType = fieldModel.get('type');
        inputType = ADF.utils.camelize(inputType);
        inputType = ADF.utils.capitalize(inputType);
        inputType = 'inputType'+inputType;

        // this.set('inputField',ADF.templates[inputType](this.toJSON()));
        if( ADF.templates[inputType] ){
            fieldModel.set('inputTemplate',ADF.templates[inputType]);
        }else{
            ADF.utils.message('error','unexpected template requested: '+inputType,fieldModel);
        }


    }

});
/*global
ADF,
Backbone,
_
*/
ADF.RecordModel = Backbone.Model.extend({

    initialize: function( attrs, opts ){
        ADF.utils.message('log','RecordModel Initialized', attrs, opts);
        var recordModel = this;

        // give the record an ID even if it is new (ie not from the database)
        if( recordModel.isNew() ){
            recordModel.set('id','a'+ADF.utils.randomId());
            recordModel.set('rowClass','added');
        }else{
            recordModel.set('rowClass','current');
        }

        // make sure all attributes are lowercase
        _.each(attrs,function(element, index, array){
            if( index.toLowerCase() !== index ){
                recordModel.set(index.toLowerCase(),element);
                recordModel.unset(index);
            }
            if( _.isArray(element) ){
                _.each(element, function( childElement, childIndex, childArray ){
                    ADF.utils.objPropToLower( childElement );
                });
                recordModel.set(index.toLowerCase(), element );
            }
        });

        this.listenTo(this,'sync',recordModel.recordSave);

    }

});

//     createTplObject: function( args ){

//         var record = this;
//         var fieldsArray = args.fields;
//         var $target = args.target;
//         var createRow = ( args.hasOwnProperty('createRow') && args.createRow );
//         var cellObj = {};
//         var recordObj = {}
//         recordObj.cells = new Array();

//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             cellObj = fieldsArray[i];
//             cellObj.set('currentValue',record.get(fieldsArray[i].get('name')));
//             cellObj.set('inputField',cellObj.render());

//             recordObj.cells.push({'html': autoAdmin.templates.gridCell( cellObj.toJSON() )});

//         }

//         //make sure we have an ID value, even for new rows
//         if( record.get('id') ){
//             recordObj.id = record.get('id');
//             recordObj.rowClass = 'current';
//         }else{
//             recordObj.id = 'a' + Math.round( Math.random() * 10000000 );
//             rowClass = 'added';
//         }

//         return recordObj;

//     },

//     render: function( args ){

//         var tplObject = this.createTplObject( args );

//         alert('not done');

//         // TODO handle create row argument, etc.

//         // if( createRow ){

//     //         if( !args.hasOwnProperty('adjSibObj') || args.adjSibObj === false ){
//     //             $target.append( autoAdmin.render.hbsTemplate( 'autoAdminGridRow', rowObj ) );
//     //         }else{
//     //             adjSibObj.after( autoAdmin.render.hbsTemplate( 'autoAdminGridRow', rowObj ) );
//     //         }

//         // }else{

//         //      $target.find('tbody tr#'+recordObj.id).replaceWith(autoAdmin.templates.gridRow( rowObj ) );

//         // }

//     //     $('#'+dataObj.id).find('.select2').each(function(){
//     //         autoAdmin.render.renderSelect2({
//     //             select2Obj : $(this)
//     //         })
//     //     });

//     },

//     save: function( e ){

//         e.preventDefault();

//         console.log('some event');

//     }
/*global
ADF,
Backbone
*/
ADF.DropdownMenuModel = Backbone.Model.extend({
    defaults: {
        buttonLabel: 'Menu Name',
        footerOptions: []
    },
    initialize: function( data ){
        ADF.utils.message('log','DropdownMenuModel Initialized', data);
    }
});
/*global
ADF,
Backbone
*/
ADF.ActionModel = Backbone.Model.extend({

    initialize: function( attrs, opts ){

        this.set('id',ADF.utils.randomId());

        ADF.utils.message('log','ActionModel initialized', opts);

    }

});
/*global
ADF,
Backbone
*/
ADF.MessageModel = Backbone.Model.extend({

    initialize: function( attrs, opts ){

        this.set('id',ADF.utils.randomId());

        ADF.utils.message('log','MessageModel initialized', opts);

    }

});
/*global
ADF,
Backbone
*/
ADF.ActionsCollection = Backbone.Collection.extend({

    model: ADF.ActionModel,

    initialize: function( models, opts ){

        ADF.utils.message('log','ActionsCollection initialized', opts);

    }

});
/*global
ADF,
Backbone
*/
ADF.FieldsCollection = Backbone.Collection.extend({

    model: ADF.FieldModel,

    initialize: function( models, options ){
        ADF.utils.message('log','FieldsCollection Initialized', models, options);
    }

});
/*global
ADF,
Backbone
*/
ADF.MessagesCollection = Backbone.Collection.extend({

    model: ADF.MessageModel,

    initialize: function( models, opts ){

        ADF.utils.message('log','MessagesCollection initialized', opts);

    }

});
ADF.RecordsCollection = Backbone.Collection.extend({

    model: ADF.RecordModel,

    initialize: function( models, options ){
        ADF.utils.message('log','RecordsCollection Initialized', models, options);

        var recordsCollection = this;

        // recordsCollection.regionName = options.regionName;

    }

});
/*global
ADF,
Backbone
*/
ADF.DropdownMenuView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.dropdownMenu,
    tagName: 'li',
    childView: ADF.DropdownItemView,
    childViewContainer: '.dropdown-menu',
    // baseEvents: {
    //     'click .dropdown-wrapper .dropdown-toggle'     : 'dropdownToggle',
    // },
    // customEvents: {},
    // events: function() {
    //     return _.extend({},this.baseEvents,this.customEvents);
    // },
    // model: new ADF.DropdownMenuModel({
    //     buttonLabel: 'Menu Name',
    //     wrapClass: 'column-selector',
    //     footerOptions: []
    // }),
    initialize: function( options ) {
        ADF.utils.message('log','DropdownMenu Initialized', options );
    }

});
/*global
ADF,
Backbone
*/
ADF.CellView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.gridCell,
    tagName: 'td',
    initialize: function( options ){
        ADF.utils.message('log','CellView Initialized', options);
        this.model.set('inputField',this.model.get('inputTemplate')(this.model.toJSON()));
        // this.setElement(this.template(this.model.toJSON()));
        // <td data-column-select-priority='{{fieldPriority}}' data-header-id='{{name}}' class='{{wrapClass}}'>
    },
    render: function() {
        // this.$el
        //     .attr('data-column-select-priority',this.model.get('fieldPriority'))
        //     .attr('data-header-id',this.model.get('name'))
        //     .addClass(this.model.get('wrapClass'));
        return this.template(this.model.toJSON());
    }
});
ADF.ColumnSelectItemView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.dropdownSelectItem,
    tagName: 'li',
    initialize: function( options ){
        ADF.utils.message('log','ColumnSelectItemView Initialized', options);
        // this.model.set('regionName',options.regionName);
    },
    renderOld: function() {
        // TODO: make this use a proper and complete HBS file rather than this weird innerHTML stuff
        this._super();
    }
});
/*global
ADF,
Backbone,
$
*/
// TODO: get this prototype to work
// ADF.ColumnSelectView = ADF.DropdownMenuView({
ADF.ColumnSelectView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.dropdownMenu,
    tagName: 'li',
    childView: ADF.ColumnSelectItemView,
    childViewContainer: '.dropdown-menu',
    // childViewOptions : function () {
    //     return { regionName: this.regionName };
    // },
    events: {
        // TODO: this should go to the parent prototype
        'click .dropdown-wrapper .dropdown-toggle'     : 'dropdownToggle',
        // TODO: create hierarchy of events somehow
        'click .adf-grid-column-group'          : 'columnSelect',
        'change .column-selector .dropdown-menu input' : 'columnSelect'
    },
    initialize: function( options ) {
        ADF.utils.message('log','ColumnSelectView Initialized', options );
        this.regionName = options.regionName;

        // TODO: this model should go to the parent prototype but something wasn't working with that so it's on the list for later
        // TODO: seems like this model shouldn't be created in the view since that's a bit backwards
        // TODO: hide this when the user clicks off of it
        this.model = new ADF.DropdownMenuModel({
            buttonLabel : 'Column Select',
            wrapClass : 'column-selector',
            footerOptions : [
                {
                    href : '#',
                    itemClass : 'adf-grid-column-group',
                    label : 'All Columns',
                    dataAttributes : [
                        {
                            'name' : 'column-select-type',
                            'value' : 'all'
                        }
                    ]
                },
                {
                    href : '#',
                    itemClass : 'adf-grid-column-group',
                    label : 'Minimum Columns',
                    dataAttributes : [
                        {
                            'name' : 'column-select-type',
                            'value' : 'min'
                        }
                    ]
                },
                {
                    href : '#',
                    itemClass : 'adf-grid-column-group',
                    label : 'Default Columns',
                    dataAttributes : [
                        {
                            'name' : 'column-select-type',
                            'value' : 'dflt'
                        }
                    ]
                }
            ]
        });

    },
    render: function() {

        // render the main bits
        this.$el.html(this.template(this.model.toJSON()));

        var columnSelect = this;

        // normally would do variables up top but this requires the html() to be created already
        var childContainer = this.$el.find(this.childViewContainer).find('.divider');

        // put the children (the fields) into the drop down but above the divider
        this.collection.each(function(model){

            // TODO: move this to the model initializer
            model.set('regionName',columnSelect.regionName);

            if( model.get('fieldPriority') !== 0 ){
                var childView = new columnSelect.childView();
                var headerCell = $('#'+columnSelect.regionName+'--'+model.get('name'));
                if( headerCell.css('display') === 'table-cell' ){
                    model.set('checked',true);
                }
                childContainer.before(childView.template(model.toJSON()));
            }

        });

        return this;
    },
    // TODO: move this to the prototype
    dropdownToggle: function( event ) {

        var $target = {};

        if( event.target ){

            event.preventDefault();
            $target = $(event.target);

        }else{      // we're just going to assume it's a jQuery object then

            $target = event;

        }

        $target.closest('.dropdown-wrapper').find('.dropdown-menu').toggleClass('hide');

    },
    columnSelect: function(e) {

        e.preventDefault();

        var colSelect = this;
        var $target = $(e.target);
        var groupType = $target.attr('data-column-select-type');

        console.log('columnselect triggered',$target,groupType,id);

        if( typeof groupType == 'undefined' ){

            var id = $target.val();
            var cells = $('#'+id+', .adf-grid td[data-header-id='+id+']');

            console.log('columnselect details',id,cells);

            if( $target.is(':checked') ){
                cells.show();
            }else{
                cells.hide();
            }

        }else{

            switch( groupType ){

                case 'all':
                    $target.closest('.dropdown-wrapper').find('.dropdown-menu :input').not(':checked').trigger('click');
                    break;

                case 'min':
                    $target.closest('.dropdown-wrapper').find('.dropdown-menu :input').each(function(){
                        var inputObj = $(this);
                        var priority = parseInt( $('#'+inputObj.val()).attr('data-column-select-priority'), 10 );
                        if( ( inputObj.is(':checked') && priority > 1 ) || ( inputObj.is(':not(:checked)') && priority <= 1 ) ){
                            inputObj.trigger('click');
                        }
                    });
                    break;

                case 'dflt':
                    var dropdownMenu = $target.closest('.dropdown-wrapper').find('.dropdown-menu');
                    $('.adf-grid th, .adf-grid td').css('display', '');
                    $('.adf-grid th').each(function(){

                        var inputObj = dropdownMenu.find(':input[value='+$(this).attr('id')+']');

                        //check the visibility of this header which is now based on the media queries
                        if( $(this).css('display') === 'table-cell' && inputObj.is(':not(:checked)') ){

                            inputObj.trigger('click');

                        }else if( $(this).css('display') === 'none' && inputObj.is(':checked') ){

                            inputObj.trigger('click');

                        }

                    });
                    break;

            }

            colSelect.dropdownToggle( $target.closest('.dropdown-wrapper').find('.dropdown-toggle') );

        }

    }

});
/*global
ADF,
Backbone,
$,
adf
*/
ADF.GridActionView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.dropdownLink,
    tagName: 'li',
    events: {
        'click' : 'handleClick'
    },
    initialize: function( options ){
        ADF.utils.message('debug','GridActionView Initialized', options);
        this.region = adf.page.getRegion(options.regionName);
    },
    handleClick: function(e){

        e.preventDefault();

        var actionView = this;
        var $action = $(e.target);

        if( $action.data('action-type') ){

            var actionType = ADF.utils.camelize( $action.data('action-type') );

            if( !actionView[actionType] ){
                ADF.utils.message('error','action type not setup',actionType);
                return;
            }
            actionView[actionType]( $action );

        }else{
            ADF.utils.message('error','Better have a TA check into this.  The action you clicked on has no type indicated so not sure what to do with it.');
        }

    },

    gridRecordAdd: function( actionObj ) {

        var gridView = this.region.gridView;
        var actionData = actionObj.data();

        ADF.utils.spin(this.region.$el);
        actionObj.closest('.dropdown-menu').addClass('hide');

        for( var i = 1; i <= actionData.recordCount; i++ ){
            gridView.collection.add({},{ at: 0 });
        }

        gridView.render();
        ADF.utils.spin(this.region.$el, { stop: true } );

    }

});
/*global
ADF,
Backbone,
$
*/
// TODO: get a prototype setup for all dropdowns to work
ADF.GridActionsView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.dropdownMenu,
    tagName: 'li',
    childView: ADF.GridActionView,
    childViewContainer: '.dropdown-menu',
    childViewOptions : function () {
        return { regionName: this.regionName };
    },
    events: {
        // TODO: this should go to the parent prototype
        'click .dropdown-wrapper .dropdown-toggle'     : 'dropdownToggle',
        // TODO: create hierarchy of events somehow
        'click .adf-grid-column-group'          : 'columnSelect',
        'change .column-selector .dropdown-menu input' : 'columnSelect'
    },
    initialize: function( options ) {
        ADF.utils.message('debug','GridActionsView Initialized', options );
        this.regionName = options.regionName;

        // TODO: this model should go to the parent prototype but something wasn't working with that so it's on the list for later
        // TODO: seems like this model shouldn't be created in the view since that's a bit backwards
        // TODO: hide this when the user clicks off of it
        this.model = new ADF.DropdownMenuModel({
            buttonLabel : 'Actions',
            wrapClass : 'grid-actions'
        });

    },
    render: function() {

        // render the main bits
        this.$el.html(this.template(this.model.toJSON()));

        var gridActions = this;

        // normally would do variables up top but this requires the html() to be created already
        var childContainer = this.$el.find(this.childViewContainer).find('.divider');

        // put the children (the fields) into the drop down but above the divider
        this.collection.each(function(model){

            // TODO: move this to the model initializer
            model.set('regionName',gridActions.regionName);

            var childView = new gridActions.childView({regionName:gridActions.regionName,model:model});
            childContainer.before(childView.template(model.toJSON()));
            // console.log('#'+gridActions.regionName+'Action--'+model.get('id'));
            childView.setElement('#'+gridActions.regionName+'Action--'+model.get('id'));

        });

        return this;
    },
    // TODO: move this to the prototype
    dropdownToggle: function( event ) {

        var $target = {};

        if( event.target ){

            event.preventDefault();
            $target = $(event.target);

        }else{      // we're just going to assume it's a jQuery object then

            $target = event;

        }

        $target.closest('.dropdown-wrapper').find('.dropdown-menu').toggleClass('hide');

    },
    columnSelect: function(e) {

        e.preventDefault();

        var colSelect = this;
        var $target = $(e.target);
        var groupType = $target.attr('data-column-select-type');

        console.log('columnselect triggered',$target,groupType,id);

        if( typeof groupType == 'undefined' ){

            var id = $target.val();
            var cells = $('#'+id+', .adf-grid td[data-header-id='+id+']');

            console.log('columnselect details',id,cells);

            if( $target.is(':checked') ){
                cells.show();
            }else{
                cells.hide();
            }

        }else{

            switch( groupType ){

                case 'all':
                    $target.closest('.dropdown-wrapper').find('.dropdown-menu :input').not(':checked').trigger('click');
                    break;

                case 'min':
                    $target.closest('.dropdown-wrapper').find('.dropdown-menu :input').each(function(){
                        var inputObj = $(this);
                        var priority = parseInt( $('#'+inputObj.val()).attr('data-column-select-priority'), 10 );
                        if( ( inputObj.is(':checked') && priority > 1 ) || ( inputObj.is(':not(:checked)') && priority <= 1 ) ){
                            inputObj.trigger('click');
                        }
                    });
                    break;

                case 'dflt':
                    var dropdownMenu = $target.closest('.dropdown-wrapper').find('.dropdown-menu');
                    $('.adf-grid th, .adf-grid td').css('display', '');
                    $('.adf-grid th').each(function(){

                        var inputObj = dropdownMenu.find(':input[value='+$(this).attr('id')+']');

                        //check the visibility of this header which is now based on the media queries
                        if( $(this).css('display') === 'table-cell' && inputObj.is(':not(:checked)') ){

                            inputObj.trigger('click');

                        }else if( $(this).css('display') === 'none' && inputObj.is(':checked') ){

                            inputObj.trigger('click');

                        }

                    });
                    break;

            }

            colSelect.dropdownToggle( $target.closest('.dropdown-wrapper').find('.dropdown-toggle') );

        }

    }

});
/*global
ADF,
Backbone
*/
ADF.MessageView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.message,
    events: {
        'click .message-remove'                        : 'messageRemove',
        'click .message-details'                       : 'showMessageInConsole'
    },
    initialize: function( options ) {
        // TODO: figure out a way for this view to use the message function without causing an infinite loop
        ADF.utils.message('log','MessageView Initialized', options);
        this.messageFormat();
    },
    messageRemove: function(e) {
        e.preventDefault();
        // TODO: this should really be just this.$el but the silly Marionette default render wraps the tpl in extra div
        this.$el.find('.message').addClass('removed');
    },
    messageFormat: function() {
        if( this.model.get('originalArguments') && !this.model.get('content') ){
            // TODO: handle the originalArguments a bit differently to make URLs into links
            // TODO: handle the originalArguments maybe having line number for a file
            this.model.set('content',ADF.utils.arrayToHTML( this.model.get('originalArguments'), 'div', 'div' ) );
        }else{
            // console.log('do not parse the array',this.model.get('originalArguments'),this.model.get('content') );
        }
    },
    showMessageInConsole: function(e) {
        e.preventDefault();
        // console[this.model.get('level')](this.model.toJSON());
        console[this.model.get('level')](this.model.get('originalArguments'));

    }
});
/*global
ADF,
Marionette
*/
// TODO: add clear all option to remove all messages
ADF.MessagesWindowView = Marionette.CollectionView.extend({

    childView: ADF.MessageView,

    initialize: function( options ) {
        ADF.utils.message('log','MessagesWindowView Initialized', options );
    }

});
/*global
ADF,
Backbone
*/
ADF.FormActionView = Backbone.Marionette.ItemView.extend({

    el: '.adf-action',
    template: ADF.templates.action,
    initialize: function( options ){
        ADF.utils.message('log','FormActionView initialized', options );
    },

    events: {
        'click a' : 'handleClick'
    },

    render: function( args ) {

        // args.target.append( ADF.templates.action( this.model.toJSON() ) );
        // this.setElement('#'+this.model.get('id'));

        return this.template( this.model.toJSON() );

    },

    // renderAsDropdownItem: function( target ) {

    //     target.before( ADF.templates.dropdownLink( this.model.toJSON() ) );

    //     this.setElement('#'+this.model.get('id'));

    // },

    // handleClick: function(e){

    //     e.preventDefault();

    //     var actionView = this;
    //     var $action = $(e.target);

    //     if( $action.data('action-type') ){

    //         var actionType = ADF.utils.camelize( $action.data('action-type') );
    //         actionView[actionType]( $action );

    //     }else{
    //         alert('Better have a TA check into this.  The action you clicked on has no type indicated so not sure what to do with it.');
    //     }

    // },

    // gridRecordAdd: function( actionObj ) {

    //     // var $target = actionObj.closest('.adf-grid-wrapper').find('tbody');
    //     var gridView = this.parentGridView;
    //     // var fieldsArray = gridView.fieldsColl.models;
    //     // var recordView;

    //     actionObj.closest('.grid-dropdown').find('.dropdown-menu').addClass('hide');

    //     for( var i = 1; i <= parseInt( actionObj.data('record-count'), 10 ); i++ ){
    //         gridView.recordsColl.add({},{ saveUrl : gridView.recordsColl.saveUrl });
    //     }

    // }

});
/*global
ADF,
Backbone,
$,
adf,
_
*/
ADF.FieldView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.formRow,
    events: {
        'change'                        : 'valueChange'
    },
    initialize: function( options ) {
        ADF.utils.message('log','FieldView Initialized', options);
        if( !_.isUndefined( this.model.get('inputTemplate') ) ){
            this.model.set('inputField',this.model.get('inputTemplate')(this.model.toJSON()));
        }else{
            ADF.utils.message('error','Attempting to assign inputField attribute to undefined template',this.model);
        }
    },
    render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        return this;
    },
    renderAsChild: function(){
        return this.template(this.model.toJSON());
    },
    valueChange: function(e) {
        // console.log('input change',e,$(e.target).val(),$(e.currentTarget).val());
        this.model.set('currentValue',$(e.target).val());
    },
    showOverlayEditor: function(e) {
        e.preventDefault();
        adf.page.getRegion('overlayEditor').show( $(e.target) );
    }
});
/*global
ADF,
Marionette,
$,
adf,
_
*/
ADF.FormView = Marionette.CollectionView.extend({

    childView: ADF.FieldView,

    initialize: function( options ) {
        ADF.utils.message('log','FormView Initialized', options );
        $.extend(this.options,options);
        // this.options
    },

    events: {
        // select handlers
        'change select[data-adf-submit-on-change=true]'                     : 'submitParentForm',
        'change select[data-adf-dependent-field-lkup-on-change=true]'       : 'dependentFieldLkup',

        // same handlers as above but now in the event that the UI has the data- attributes on a parent "wrapper" element rather than right on the select
        'change [data-adf-submit-on-change=true] select'                    : 'submitParentForm',
        'change [data-adf-dependent-field-lkup-on-change=true] select'      : 'dependentFieldLkup',

        // button handlers
        'click .btn-submit'                                                 : 'submitParentForm',
        'click .btn-query'                                                  : 'submitParentForm',

        // form submission
        'submit'                                                            : 'submitForm'
    },

    render: function() {

        // the normal render
        var formView = this;
        formView._super();

        // rendering the 'actions' for a given form
        // start by getting the region since that is where the actions are kept
        var region = adf.page[formView.options.regionName];

        // see if we have any actions because if we don't we can stop right away
        if( region.actionsCollection.length > 0 ){
            formView.$el.append(ADF.templates.formRow({
                name: 'ACTIONS',
                fldMstrId: 0
            }));

            var childContainer = formView.$el.find('#ACTIONS-field-wrap .form-input');

            region.actionsCollection.each( function( action ) {
                var childView = new ADF.FormActionView({model:action});
                childContainer.append(childView.render());
            });

        }

        ADF.utils.select2.refresh();

    },

    submitParentForm: function( e ) {

        e.preventDefault();
        $(e.target).closest('form').submit();

    },

    submitForm: function( e ) {

        var $form = $(e.target);
        var action = $form.attr('action');
        var region = adf.page.findRegion({
            attribute : 'el',
            value : action
        });

        if( action.substring(0,1) === '#' ){

            if( $(action).size() > 0 ){

                ADF.utils.message('log','Found something to load into');
                e.preventDefault();

                console.log();

                region.ajax({
                    data: JSON.stringify($form.serializeObject()),
                    method: 'POST'
                });

            }else{
                ADF.utils.message('error','Trying to load ajax but destination element could not be found on the page');
            }
        }else{
            // TODO: just let the form submit
            return true;
        }

    },

    dependentFieldLkup: function(e) {

        var formView = this;
        var dataObj = {};
        var $parentRow = $(e.target).closest('.form-row');
        // var $form = $parentRow.closest('form');
        var parentData = $parentRow.data();
        var $target = $('#'+parentData.fieldLkupTarget+'-field-wrap');
        var childFields = parentData.adfDependentFieldLkupChildFields ? parentData.adfDependentFieldLkupChildFields.split(',') : null;
        var region = adf.page[formView.options.regionName];

        e.preventDefault();
        ADF.utils.message('log','dependentFieldLkup',e);

        formView.collection.each(function( model ) {
            dataObj[model.get('fldMstrId')] = model.get('currentValue');
        });

        _.each(childFields,function( fieldName ){
            var modelToRemove = formView.collection.filter(function( model ){
                return model.get('name') === fieldName;
            });
            formView.collection.remove(modelToRemove);
            $('#'+fieldName+'-field-wrap').remove();
        });

        if( $target.size() === 0 ){
            // TODO:somehow also remove any prefix/suffix for this field upon load of the new stuff
            // TODO:allow field to be dropped into the middle of a form rather than append to the form

            $target = $parentRow;
        }else{
            $target.remove();
            $target = $parentRow;
        }

        region.ajax({
            data: JSON.stringify(dataObj),
            url: parentData.adfDependentFieldLkupUrl,
            emptyCollections:false
        });

    }
});
/*global
ADF,
Backbone,
adf,
$
*/
// TODO: have module and record views share a common prototype
ADF.ModuleView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.module,
    childView: ADF.FieldView,
    childContainer: '.module-details',
    events: {
        'adf-module-drop'                       : 'drop',
        'adf-module-remove'                     : 'remove',
        'click .module-details-toggle'          : 'toggleDetails',
        'change :input'                         : 'inputChange',
        'click .btn'                            : 'handleAction'
    },
    initialize: function( options ) {
        ADF.utils.message('log','ModuleView Initialized', options);
        this.region = adf.page.getRegion(options.regionName);
        this.collection = this.region.fieldsCollection;
        // this.listenTo(this.model,'sync', this.moduleAction);
        // this.listenTo(this.model,'error',this.moduleAction);
        this.listenTo(this.model,'all',this.moduleAction);
    },
    render: function() {

        // TODO: this is getting an extra DIV wrapper when rendering
        var fieldsString = '';

        var moduleView = this;

        // put the children (the fields) into the drop down but above the divider
        this.collection.each(function(model){

            model.set('currentValue',moduleView.model.get(model.get('name')));
            var childView = new moduleView.childView({model:model});
            fieldsString += childView.renderAsChild();

        },this);

        this.$el.html(this.template($.extend({},this.model.toJSON(),{fields:fieldsString})));
        return this;
    },
    toggleDetails: function(e) {
        e.preventDefault();
        this.$el.find('.module-details').toggleClass('hide');
    },
    handleAction: function(e) {
        e.preventDefault();
        e.stopPropagation();        //since the parent ModulesView will likely have this same event listener
        var $targetObj = $(e.target).closest('a');
        var actionType = $targetObj.attr('data-action-type');
        // TODO: experiment with making this dynamic
        switch( actionType ){
            case 'save':
                this.model.url = $targetObj.attr('href');
                this.model.save(null,{});
                break;
            default:
                ADF.utils.message('error','Unexpected record action ('+actionType+') triggered.',$targetObj);
        }
    },
    inputChange: function( e ){

        // stopping the propagation for overlay changes so they don't change the master
        e.preventDefault();
        e.stopPropagation();

        var changed = e.currentTarget;
        var value = $(e.currentTarget).val();
        var obj = {};
        obj[changed.name] = value;

        this.model.set(obj);

        this.$el.removeClass('current').addClass('updated');

    },
    moduleAction: function( event, model, response, options ) {

        if( model.get('id') === 11115 ){
            // console.log(event,model.get('id'));
            // console.log(event,response,options);
        }

        console.log(event,response,options);

        if( options && options.xhr ){

            if( options.xhr.status === 200 ){

                ADF.utils.message('debug','Module action completed successfully',model,options.xhr.responseJSON,options);

                if( options.xhr.responseJSON.success ){
                    this.$el.removeClass('updated new error').addClass('current');
                }else{
                    this.$el.removeClass('updated new current').addClass('error');
                    ADF.utils.message('warn','Something went wrong in saving the module',model,options.xhr.responseJSON,options);
                }

            }else{

                this.$el.removeClass('updated new current').addClass('error');
                ADF.utils.message('error','Something unexpected went wrong in saving the module',model,options.xhr.responseJSON,options);

            }

        }

    },
    drop: function(e, i){
        // console.log('moduled dropped',e,i);
        this.$el.trigger('adf-module-received',[this.model, i]);
    },
    remove: function(e, i){
        if( e && e.type === 'adf-module-remove' ){
            console.log('module remove',e,i);
            this.$el.trigger('adf-module-sent',[this.model, i]);
        }
    }

});
/*global
ADF,
Marionette,
adf,
$
*/
ADF.ModulesView = Marionette.CollectionView.extend({

    template: ADF.templates.moduleListWrapper,
    childView: ADF.ModuleView,
    childViewContainer: '.module-list-wrapper',
    childViewOptions: function() {
        return { regionName: this.regionName };
    },
    events: {
        'adf-module-received'           : 'moduleReceived',
        'adf-module-sent'               : 'moduleSent',
        'click .btn'                    : 'handleAction'
    },
    initialize: function( options ) {
        ADF.utils.message('log','ModulesView Initialized', options );
        this.regionName = options.regionName;
        this.dndSource = options.dndSource;
        this.dndTarget = options.dndTarget;

        // TODO: seems like this should be in the initialize
        if( this.dndSource ){
            adf.page.dndSources.push(this);
        }
        if( this.dndTarget ){
            adf.page.dndTargets.push(this);
        }
    },
    render: function() {

        // the normal render
        var modulesView = this;
        // modulesView.$el.find('#ACTIONS-field-wrap').remove();
        modulesView.$el.empty();
        modulesView._super();

        // console.log('within render',modulesView.collection);

        // rendering the 'actions' for a given form
        // start by getting the region since that is where the actions are kept
        var region = adf.page.getRegion(modulesView.options.regionName);

        // TODO: commonize this "action collection" handling since it's here and in the form view
        // see if we have any actions because if we don't we can stop right away
        if( region.actionsCollection.length > 0 ){
            modulesView.$el.append(ADF.templates.formRow({
                name: 'ACTIONS',
                fldMstrId: 0
            }));

            var childContainer = modulesView.$el.find('#ACTIONS-field-wrap .form-input');

            region.actionsCollection.each( function( action ) {
                var childView = new ADF.FormActionView({model:action});
                childContainer.append(childView.render());
            });

        }

        // drag and drop setup
        if( modulesView.dndSource ){

            modulesView.$el.sortable({
                handle: '.dnd-handle',
                connectWith: '.dnd-wrapper[data-adf-dnd-target=true]',
                placeholder: 'module-placeholder',
                stop: function(event, ui) {
                    ui.item.trigger('adf-module-drop', ui.item.index());
                },
                remove: function(event, ui) {
                    console.log('remove');
                    ui.item.trigger('adf-module-remove', ui.item.index());
                },
                activate: function( event, ui ) {
                    modulesView.$el.addClass('dnd-active');
                },
                deactivate: function( event, ui ) {
                    modulesView.$el.removeClass('dnd-active');
                }
            });

        }

        //     dndSourceInit: function( opts ) {

//         var modulesView = this;

//         if( opts.destroy ){
//             // modulesView.$el.sortable('destroy');
//         }

//         modulesView.$el.sortable({
//             connectWith: '.dnd-wrapper.dnd-target'
//         }).bind('dragstart.h5s', function(e, ui) {
//             console.log(e);
//         });

//     },

    },
    handleAction: function(e) {
        e.preventDefault();
        var modulesView = this;
        var $targetObj = $(e.target).closest('a');
        var actionType = $targetObj.attr('data-action-type');
        // TODO: experiment with making this dynamic
        switch( actionType ){
            case 'save':
                modulesView.collection.each(function( moduleModel ){
                    moduleModel.url = $targetObj.attr('href');
                    moduleModel.save(null,{});
                });
                break;
            default:
                ADF.utils.message('error','Unexpected record action ('+actionType+') triggered.',$targetObj);
        }
    },
    moduleReceived: function( e, model, position ) {

        var modulesView = this;

        // TODO: fetch the new page detail object
        // console.log('modulesView moduleDrop',this.regionName,e,model,position);
        // console.log('record to be added at position',position);
        // this.collection.remove(model);
        // this.collection.each(function(model, index){
        //   var ordinal = index;
        //   if(index >= position){
        //     ordinal+=1;
        //   }
        //   // model.set('ordinal', ordinal);
        // });

        // model.set('ordinal', position);
        modulesView.collection.add(model, {at: position});
        // modulesView.collection.add(new ADF.RecordModel({}));
        // console.log(modulesView.collection);
        modulesView.render();
    },
    moduleSent: function( e, model, position ) {
        var modulesView = this;
        // console.log('moduleSent');
        modulesView.collection.remove(model);
    }


});

// ADF.ModulesView = Backbone.View.extend({

//     initialize: function(opts){
//         var modulesView = this;

//         this.listenTo(this,'modulesRendered', function(){

//             // TODO: somehow setup these to not care which order they happen in (issue is present in form-builder)

//             if( modulesView.$el.hasClass('dnd-source') ){

//                 modulesView.dndSourceInit({destroy: true});
//                 _.each(modulesView.pageView.dndTargets,function(element, index, array){
//                     element.dndTargetInit({destroy: true});
//                 });
//                 modulesView.pageView.dndSources.push(modulesView);

//             }else if( modulesView.$el.hasClass('dnd-target') ){

//                 modulesView.dndTargetInit({destroy: true});
//                 _.each(modulesView.pageView.dndSources,function(element, index, array){
//                     element.dndSourceInit({destroy: true});
//                 });
//                 modulesView.pageView.dndTargets.push(modulesView);

//             }

//             ADF.utils.spin(opts.target, { stop: true } );

//         });

//         modulesView.render();

//     },

//     events: {
//         // ACTIONS
//         'click .btn-save'                     : 'saveModules'
//     },

//     render: function() {

//         var modulesView = this;

//         this.setElement(modulesView.target);

//         modulesView.trigger('modulesWrapperRendered');

//     },

//     renderModules: function() {

//         var modulesView = this;
//         modulesView.$el.sortable('destroy');

//         for ( var j = 0; j < modulesView.recordsColl.models.length; j++ ) {

//             modulesView.recordsColl.models[j].recordView.renderModule({
//                 target : modulesView.$el,
//                 fields : modulesView.fieldsColl.models
//             });

//         }

//         for ( var j = 0; j < modulesView.actionsColl.models.length; j++ ) {

//             // console.log(modulesView.actionsColl.models[j]);

//             modulesView.actionsColl.models[j].actionView.render({
//                 target : modulesView.$el
//             });

//         }

//         modulesView.trigger('modulesRendered');

//     },

//     ajax: function( opts ) {

//         var modulesView = this;

//         $.ajax({
//             url: opts.url,
//             type: opts.method,
//             data: opts.data,
//             dataType: ( opts.resultType === 'html' ? 'html' : 'json' ),
//             beforeSend: function(){
//                 ADF.utils.spin(opts.target);
//             },
//             complete: function( jqXHR, textStatus ){

//                 if( jqXHR.status === 200 ){

//                     if( !jqXHR.hasOwnProperty('responseJSON') ){
//                         jqXHR.responseJSON = JSON.parse(jqXHR.responseText);
//                     }

//                     ADF.utils.log('AJAX message: '+jqXHR.responseJSON.message);

//                     if( jqXHR.responseJSON.success === true ){

//                         if( jqXHR.responseJSON.data.hasOwnProperty('records') ){
//                             modulesView.recordsColl.add( jqXHR.responseJSON.data.records );
//                         }

//                         if( jqXHR.responseJSON.data.hasOwnProperty('fields') ){
//                             modulesView.fieldsColl.add( jqXHR.responseJSON.data.fields );
//                         }

//                         if( jqXHR.responseJSON.data.hasOwnProperty('actions') ){
//                             modulesView.actionsColl.add( jqXHR.responseJSON.data.actions );
//                         }

//                         modulesView.trigger('ajaxLoaded');

//                     }else{

//                         if( jqXHR.responseJSON.hasOwnProperty('errors') ){
//                             _.each(jqXHR.responseJSON.errors,function( element, index, array ){
//                                 alert(element);
//                             });
//                         }else{
//                             alert('Looks like the ajax response wasn\'t quite what was expected from '+opts.url+'.  Probably need to get a TA involved.');
//                         }

//                     }

//                 }else if( jqXHR.status === 404 ){

//                     alert('Page Not Found<br>The ajax calls is being made to a page ('+opts.url+') that could not be found. Probably going to need to get a TA involved to see what is going on here.');

//                 }else{

//                     alert(textStatus+'! Probably going to need to get a TA involved.');
//                     console.log('opts',opts);
//                     console.log(jqXHR);
//                     // target.html(jqXHR.responseText);

//                 }

//             }
//         });

//     },

//     saveModules: function( e ){

//         e.preventDefault();

//         var modulesView = this;

//         _.each(modulesView.recordsColl.models, function( element, index, array ){

//             element.save(null,{});

//         });

//     },

//     dndSourceInit: function( opts ) {

//         var modulesView = this;

//         if( opts.destroy ){
//             // modulesView.$el.sortable('destroy');
//         }

//         modulesView.$el.sortable({
//             connectWith: '.dnd-wrapper.dnd-target'
//         }).bind('dragstart.h5s', function(e, ui) {
//             console.log(e);
//         });

//     },

//     dndTargetInit: function( opts ) {

//         var modulesView = this;
//         var $target;

//         if( opts.destroy ){
//             // modulesView.$el.sortable('destroy');
//         }

//         modulesView.$el.sortable({
//             connectWith: '.dnd-wrapper.dnd-source'
//         }).bind('dragstart.h5s', function(e, ui) {
//             console.log(e);
//         }).bind('sortupdate', function(e,ui) {

//             $target = $(e.target);

//             var nextRecordId = parseInt( ui.item.next().attr('id'), 10 );
//             var nextModel = modulesView.recordsColl.findWhere({id:nextRecordId});
//             var nextIdx = modulesView.recordsColl.indexOf(nextModel);

//             console.log( nextRecordId, nextModel, nextIdx );

//             // is the drag from an outside parent
//             if( ui.startparent.attr('id') !== ui.endparent.attr('id') ){

//                 console.log(ui.item.find(':input').serializeObject());

//                 $.ajax({
//                     url: modulesView.recordsColl.newUrl,
//                     type: 'POST',
//                     contentType: 'application/json',
//                     data: JSON.stringify(ui.item.find(':input').serializeObject()),
//                     dataType: 'json',
//                     beforeSend: function(){
//                         ADF.utils.spin(modulesView.$el);
//                     },
//                     complete: function( jqXHR, textStatus ){

//                         if( jqXHR.status === 200 ){

//                             if( !jqXHR.hasOwnProperty('responseJSON') ){
//                                 jqXHR.responseJSON = JSON.parse(jqXHR.responseText);
//                             }

//                             ADF.utils.log('AJAX message: '+jqXHR.responseJSON.message);

//                             if( jqXHR.responseJSON.success === true ){

//                                 if( jqXHR.responseJSON.data.hasOwnProperty('records') ){
//                                     modulesView.recordsColl.add( jqXHR.responseJSON.data.records, { at: nextIdx } );
//                                 }

//                                 modulesView.$el.empty();
//                                 modulesView.renderModules();

//                             }else{

//                                 if( jqXHR.responseJSON.hasOwnProperty('errors') ){
//                                     _.each(jqXHR.responseJSON.errors,function( element, index, array ){
//                                         alert(element);
//                                     });
//                                 }else{
//                                     alert('Looks like the ajax response wasn\'t quite what was expected from '+opts.url+'.  Probably need to get a TA involved.');
//                                 }

//                             }

//                         }else if( jqXHR.status === 404 ){

//                             alert('Page Not Found\n\nThe ajax calls is being made to a page ('+opts.url+') that could not be found. Probably going to need to get a TA involved to see what is going on here.');

//                         }else{

//                             alert(textStatus+'! Probably going to need to get a TA involved.');
//                             console.log('opts',opts);
//                             console.log(jqXHR);
//                             // target.html(jqXHR.responseText);

//                         }

//                     }
//                 });

//             // drag is happening within a list, just need to resort
//             }else{

//                 var thisId = parseInt( ui.item.attr('id'), 10 );
//                 var thisModel = modulesView.recordsColl.findWhere({id:thisId});
//                 var thisIdx = modulesView.recordsColl.indexOf(thisModel);
//                 modulesView.recordsColl.remove(thisModel);

//                 // TODO: HANDLE DRAG WITHIN TARGET
//                         // reorder: function(new_index, original_index) {
//                         //         // If nothing is being changed, don't bother
//                         //         if (new_index is original_index) return this
//                         //         // Get the model being moved
//                         //         temp = collection.at(original_index)
//                         //         // Remove it
//                         //         collection.remove(temp)
//                         //         // Add it back in at the new index
//                         //         collection.add(temp, {at: new_index))
//                         //         return this
//                         // }
//                 if( thisIdx > nextIdx ){
//                     modulesView.recordsColl.add( thisModel, { at: nextIdx } );
//                 }else{
//                     modulesView.recordsColl.add( thisModel, { at: ( nextIdx - 1 ) } );
//                 }
//                 modulesView.$el.empty();
//                 _.each( modulesView.recordsColl, function( element, index, array ){
//                     modulesView.recordsColl.models[index].set('read_order',( index * 10 ) + 10);
//                 });
//                 modulesView.renderModules();

//             }

//         }).bind('dragenter.h5s', function(e) {
//             if( $(e.target).parent().hasClass('dnd-target') ){
//                 $(e.target).css({
//                     background: 'orange'
//                 });
//             }
//         });


//     }

// });
/*global
ADF,
Marionette,
adf,
$
*/
ADF.RecordView = Marionette.CompositeView.extend({
    template: ADF.templates.gridRow,
    tagName: 'tr',
    className: 'adf-record',
    childView: ADF.CellView,
    childViewClass: ADF.CellView,
    events: {
        'change :input'                 : 'inputChange',
        'click .btn'                    : 'handleAction',
        'click .adf-grid-overlay-value' : 'showOverlayEditor'
    },
    initialize: function( options ) {
        ADF.utils.message('log','RecordView Initialized', options );
        this.region = adf.page.getRegion(options.regionName);
        this.regionName = this.region.options.regionName;
        this.model.set('regionName',this.regionName);
        this.collection = this.region.fieldsCollection;
        this.listenTo(this.model,'sync', this.recordAction);
        this.listenTo(this.model,'error',this.recordAction);
    },
    renderSelf: function() {
        // this would be called when the record has changed and needs to be rerendered
        // TODO: make this actually work for both rendering on initial load (as child) and as standalone record (on change)
        this.render();
    },
    render: function() {

        var cellsString = '';

        var recordView = this;

        // put the children (the fields) into the drop down but above the divider
        this.collection.each(function(model){

            // TODO: move this to the model initializer
            model.set('regionName',recordView.regionName);
            model.set('currentValue',recordView.model.get(model.get('name')));
            var childView = new recordView.childView({model:model});
            // this.addChild(childView);
            // console.debug(childView.render());
            cellsString += childView.render();
            // this.addChild(childView);

        },this);

        return this.template($.extend({},this.model.toJSON(),{cells:cellsString}));
    },
    renderAsChild: function() {

        var cellsString = '';

        var recordView = this;

        // put the children (the fields) into the drop down but above the divider
        this.collection.each(function(model){

            // TODO: move this to the model initializer
            model.set('regionName',recordView.regionName);
            model.set('currentValue',recordView.model.get(model.get('name')));
            var childView = new recordView.childView({model:model});
            // this.addChild(childView);
            // console.debug(childView.render());
            cellsString += childView.render();
            // this.addChild(childView);

        },this);

        return this.template($.extend({},this.model.toJSON(),{cells:cellsString}));
    },
    handleAction: function(e) {
        e.preventDefault();
        var $targetObj = $(e.target).closest('a');
        var actionType = $targetObj.attr('data-action-type');
        // TODO: experiment with making this dynamic
        switch( actionType ){
            case 'save':
                this.model.url = $targetObj.attr('href');
                this.model.save(null,{});
                break;
            default:
                ADF.utils.message('error','Unexpected record action ('+actionType+') triggered.',$targetObj);
        }
    },
    showOverlayEditor: function(e) {
        // TODO: find the actual cell that had this event and then trigger with that as the trigger object
        e.preventDefault();
        adf.page.getRegion('overlayEditor').show( $(e.target) );
    },
    inputChange: function( e ){

        // stopping the propagation for overlay changes so they don't change the master
        e.preventDefault();
        e.stopPropagation();

        var changed = e.currentTarget;
        var value = $(e.currentTarget).val();
        var obj = {};
        obj[changed.name] = value;

        this.model.set(obj);

        this.$el.removeClass('current').addClass('updated');

    },

    recordAction: function( model, response, options ) {

        if( options.xhr.status === 200 ){

            ADF.utils.message('debug','Record action completed successfully',model,response,options);

            if( response.success ){
                this.$el.removeClass('updated new error').addClass('current');
            }else{
                this.$el.removeClass('updated new current').addClass('error');
                ADF.utils.message('error','Something went wrong in saving the record',model,response,options);
            }

        }else{

            this.$el.removeClass('updated new current').addClass('error');
            ADF.utils.message('error','Something unexpected went wrong in saving the record',model,response,options);

        }

    }

});

//     events: {
//         // ACTIONS
//         'click .btn-save'                     : 'save'
//     },

//     createTplObject: function( args ){

//         var record = this;
//         var fieldsArray = args.fields;
//         var $target = args.target;
//         var createRow = ( args.hasOwnProperty('createRow') && args.createRow );
//         var cellObj = {};
//         var recordObj = {}
//         recordObj.cells = new Array();

//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             cellObj = fieldsArray[i];
//             cellObj.set('currentValue',record.get(fieldsArray[i].get('name')));
//             cellObj.set('inputField',cellObj.render());

//             recordObj.cells.push({'html': autoAdmin.templates.gridCell( cellObj.toJSON() )});

//         }

//         //make sure we have an ID value, even for new rows
//         if( record.get('id') ){
//             recordObj.id = record.get('id');
//             recordObj.rowClass = 'current';
//         }else{
//             recordObj.id = 'a' + Math.round( Math.random() * 10000000 );
//             rowClass = 'added';
//         }

//         return recordObj;

//     },

//     render: function( args ){

//         var tplObject = this.createTplObject( args );

//         alert('not done');

//         // TODO handle create row argument, etc.

//         // if( createRow ){

//     //         if( !args.hasOwnProperty('adjSibObj') || args.adjSibObj === false ){
//     //             $target.append( autoAdmin.render.hbsTemplate( 'autoAdminGridRow', rowObj ) );
//     //         }else{
//     //             adjSibObj.after( autoAdmin.render.hbsTemplate( 'autoAdminGridRow', rowObj ) );
//     //         }

//         // }else{

//         //      $target.find('tbody tr#'+recordObj.id).replaceWith(autoAdmin.templates.gridRow( rowObj ) );

//         // }

//     //     $('#'+dataObj.id).find('.select2').each(function(){
//     //         autoAdmin.render.renderSelect2({
//     //             select2Obj : $(this)
//     //         })
//     //     });

//     },

// });
/*global
ADF,
Marionette,
adf,
$
*/
ADF.GridView = Marionette.CompositeView.extend({
    // TODO: grid-row messaging
    // TODO: overlay template adjusted to handle array of data with format/delimiter from data-supl-info attribute
    // TODO: grid-level action for saving all records

    className: 'adf-grid',
    tagName: 'table',
    childView: ADF.RecordView,
    childViewClass: ADF.RecordView,
    childViewContainer: 'tbody',
    childViewOptions : function () {
        return { regionName: this.regionName };
    },
    template: ADF.templates.gridTable,
    initialize: function( options ) {
        ADF.utils.message('log','GridView Initialized', options );
        this.regionName = options.regionName;
        var gridView = this;
        var region = adf.page[gridView.regionName];
        gridView.$el.html(gridView.template({}));

        gridView.headersView = new ADF.HeadersView({
            el: gridView.$el.find('thead')[0],
            collection: region.fieldsCollection,
            regionName: gridView.regionName
        });

        gridView.columnSelect = new ADF.ColumnSelectView({
            el: gridView.$el.find('.adf-grid-column-select')[0],
            collection: region.fieldsCollection,
            regionName: gridView.regionName
        });

        gridView.gridActions = new ADF.GridActionsView({
            el: gridView.$el.find('.adf-grid-actions')[0],
            collection: region.actionsCollection,
            regionName: gridView.regionName
        });

        this._super();

    },
    render: function() {
        var gridView = this;
        gridView.headersView.render();
        gridView.columnSelect.render();
        gridView.gridActions.render();
        var childContainer = this.$el.find(this.childViewContainer);
        // console.log(gridView.collection.length);
        childContainer.empty();
        gridView.collection.each(function(recordModel) {

            // this works but we end up with the wrong rendering
            // something about the record render() not returning 'this' is causing a problem
            // TODO: make this work so we can take more advantage of Marionette
            // gridView.addChild(recordModel, this.childView );

            // and this works but then we are doing a bunch of stuff that it seems like Marionette should be doing for us
            var childView = new gridView.childView($.extend({},gridView.childViewOptions(),{model:recordModel}));
            childContainer.append(childView.renderAsChild());
            childView.setElement('#'+recordModel.get('regionName') + '--' + recordModel.get('id'));

        },this);

        ADF.utils.select2.refresh();

        // console.log(gridView.children);
    }

});

// autoAdmin.GridView = autoAdmin.PageView.extend({

//     render: function( opts ){

//         var gridView = this;
//         var $target = opts.target;
//         var fieldsArray = opts.ajaxView.fieldsColl.models;
//         var recordsArray = opts.ajaxView.recordsColl.models;
//         var gridObj = {};

//         gridObj.headers = new Array();
//         gridObj.colSelectCols = new Array();
//         gridObj.records = new Array();

//         // COLUMNS
//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             fieldsArray[i].set('colIndex',i);
//             fieldsArray[i].set('gridRow',true);

//             gridObj.headers[i] = { 'html' : autoAdmin.templates.gridHeaderCell( fieldsArray[i].toJSON() ) };

//             if( fieldsArray[i].get('columnSelectPriority') != 0 ){

//                 // TODO: set the checked attribute if this is going to be visible

//                 gridObj.colSelectCols.push({'html' : autoAdmin.templates.dropdownSelectItem( $.extend( fieldsArray[i].toJSON(), {parent:'column-selector'} ) ) });

//             }

//         }

//         // put those fields into records
//         for ( var j = 0; j < recordsArray.length; j++ ) {

//             gridObj.records.push({
//                 'html' : autoAdmin.templates.gridRow( recordsArray[j].createTplObject({fields : fieldsArray}))
//             });

//         }

//         gridObj.colSelect = gridView.renderColumnSelector( gridObj.colSelectCols );

//         // TODO grid actions

//         $target.html( autoAdmin.templates.gridWrapper( gridObj ) );

//         gridView.refreshFilters( $target, fieldsArray );

//         $target.find('.select2').each(function(){
//             autoAdmin.utils.renderSelect2({
//                 select2Obj : $(this)
//             })
//         })

//     },

//     refreshFilters: function( $target, fieldsArray ){

//         var gridView = this;
//         var rows = $target.find('tbody tr');
//         var val;
//         var fieldName;
//         var field;
//         var values = new Array();

//         // go through each column
//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             field = fieldsArray[i];

//             fieldName = field.get('name');

//             if( fieldName === 'actions' ){
//                 continue;
//             }

//             // reset for each column
//             values = {}

//             rows.each(function(){

//                 // cache it
//                 var inputElement = $(this).find('td').eq(i).find(':input[name='+fieldName+']');

//                 // BUG select2 values being accumulated into filters not working properly
//                 val = ( inputElement.val() ? inputElement.val() : inputElement.select2('val') );

//                 if( val && val.length > 0 ){
//                     values[val] = val;
//                 }

//             })

//             //add these to the main columns array
//             if( _.size(values) > 0 ){
//                 field.set('currentValues',values);
//             }

//             // refresh the filter
//             gridView.refreshFilterOptions( $target, field );

//         }

//     },

//     refreshFilterOptions: function( $target, field ){

//         var th = $target.find('thead tr th').eq(field.get('colIndex'));
//         var tmpltObj = {};
//         var dropdownObj = {
//             wrapClass : 'grid-header-filter',
//             footerOptions : [
//                 {
//                     href : '#',
//                     itemClass : 'grid-header-filter-clear',
//                     label : 'Clear Filters'
//                 }
//             ]
//         }

//         //remove all filter data
//         th.find('.dropdown-wrapper').remove();
//         th.append( autoAdmin.templates.dropdownMenu( dropdownObj ) );

//         //only attempt to do something if there are values in there
//         if( _.size(field.get('currentValues')) > 0 ){

//             th.addClass('has-filter').find('.icon-filter').removeClass('hide')

//             for( var value in field.get('currentValues') ){

//                 tmpltObj.name = value;
//                 tmpltObj.parent = field.get('name');
//                 if( field.get('data') && field.get('data').length > 0 ){

//                     for( var rec in field.get('data').data ){

//                         if( field.get('data')[rec].value == value ){

//                             tmpltObj.label = ( field.get('data')[rec].hasOwnProperty('label') ? field.get('data')[rec].label : field.get('data')[rec].value );
//                             break;

//                         }

//                     }

//                 }else{

//                     tmpltObj.label = value;

//                 }

//                 th.find('.dropdown-menu .divider').before( autoAdmin.templates.dropdownSelectItem( tmpltObj ) );

//             }

//         }else{

//             th.find('.icon-filter').addClass('hide');

//         }

//     },

// });
ADF.HeaderView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.gridHeaderCell,
    tagName: 'th',
    initialize: function( options ){
        ADF.utils.message('log','HeaderView Initialized', options);
        this.model.set('colIndex',this.model.collection.indexOf(this.model))
        this.model.set('regionName',options.regionName);
    },
    render: function() {
        // TODO: use hbs template rather than all this silly JS
        this.$el
            .attr('data-column-select-priority',this.model.get('fieldPriority'))
            .attr('id',this.model.get('regionName') + '--' + this.model.get('name'))
            .attr('data-column-index',this.model.get('colIndex'))
            .addClass(this.model.get('wrapClass'));
        if( this.model.get('tooltip') ){
            this.$el.addClass('has-tooltip');
        }
        // return this.template(this.model.toJSON());
        this._super();
    }
});
ADF.HeadersView = Backbone.Marionette.CollectionView.extend({
    template: ADF.templates.gridRow,
    tagName: 'tr',
    childView: ADF.HeaderView,
    childViewOptions : function () {
        return { regionName: this.regionName };
    },
    initialize: function( options ) {
        // TODO: get the children to render inside this <tr>
        ADF.utils.message('log','HeadersView Initialized', options );
        this.regionName = options.regionName;
    }

});
// 'use strict';
// window.autoAdmin = window.autoAdmin || {};

// autoAdmin.PageView = Backbone.View.extend({

//     el: '.auto-admin-page',

//     initialize: function(opts){
//         var that = this;

//         this.onloadAjax();

//         this.listenTo( Backbone, 'onloadAjaxCheck', function () {
//             this.onloadAjax();
//         }, this );
//     },

//     events: {
//         // AJAX
//         'change .submit-on-change'                     : 'submitParentFormAjax',
//         'click .load-on-click'                         : 'loadOnClickAjax',
//         'click .submit-parent-form-ajax'               : 'submitParentFormAjax',

//         // TODO apply filters action
//     },

//     submitAjax: function( ajaxObj ) {

//         var that = this;
//         this.ajaxViews = new Array();

//         switch( ajaxObj.resultType ){
//             case 'form':
//                 that.ajaxViews.push(new autoAdmin.FormView(ajaxObj));
//                 break;
//             case 'grid':
//                 that.ajaxViews.push(new autoAdmin.GridView(ajaxObj));
//                 break;
//             case 'html':
//                 that.ajaxViews.push(new autoAdmin.HtmlView(ajaxObj));
//                 break;
//             default:
//                 alert('Unexpected result type: '+resultType+'.  Probably going to need to a get a TA involved.');
//                 break;

//         }

//     },

//     onloadAjax: function(){

//         var pageView = this;

//         //there might be more than one on the page when the page loads (or when a partial loads)
//         $('body').find('.auto-admin-onload-ajax').each(function(){

//             var triggerObj = $(this);
//             var target = triggerObj;
//             var ajaxObj = {};

//             if( triggerObj.attr('data-onload-ajax-target-id') != '' ){
//                 target = $('#'+triggerObj.attr('data-onload-ajax-target-id'));
//             }

//             ajaxObj.url = triggerObj.attr('data-onload-ajax-url');
//             ajaxObj.method = 'GET';
//             ajaxObj.data = '';
//             ajaxObj.target = target;
//             ajaxObj.resultType = triggerObj.attr('data-result-type');

//             triggerObj.removeClass('auto-admin-onload-ajax');

//             pageView.submitAjax( ajaxObj );

//         })

//     },

//     formSubmitAjax: function( $trigger ){

//         // e.preventDefault();     //just to make sure we don't submit anything

//         var pageView = this;
//         var $form = $trigger.is('form') ? $trigger : $trigger.closest('form');
//         var ajaxObj = {};

//         ajaxObj.url = $form.attr('action');
//         ajaxObj.method = $form.attr('method');
//         ajaxObj.data = $form.serializeObject();
//         ajaxObj.target = $('#'+$form.attr('data-target-id'));
//         ajaxObj.resultType = $form.attr('data-result-type');

//         pageView.submitAjax( ajaxObj );

//     },

//     submitParentFormAjax: function(e) {

//         e.preventDefault();
//         this.formSubmitAjax( $(e.target) );

//     },

//     loadOnClickAjax: function(e) {

//         // don't want to follow the link
//         e.preventDefault();

//         var pageView = this;
//         var linkObj = $(e.target);
//         var ajaxObj = {};

//         ajaxObj.url = linkObj.attr('href');
//         ajaxObj.method = 'get';
//         ajaxObj.data = '';
//         ajaxObj.target = $('#'+linkObj.attr('data-load-on-click-target-id'));
//         ajaxObj.resultType = linkObj.attr('data-result-type');

//         pageView.submitAjax( ajaxObj );

//     },

// });
/*global
$,
adf
*/
$(function(){

	// $.event.props.push('dataTransfer');

  //   $('body')
  //       .on('click','.refresh-menu',function(e){
  //       	e.preventDefault();
  //       	autoAdmin.core.refreshTemplates(true);
  //       })
  //       .on('click', '.auto-admin-grid-overlay-editor .display-value',function(){
  //       	autoAdmin.grid.showOverlayEditor( $(this).parent() );
  //       })
  //       .on('click', '.auto-admin-grid-overlay-editor .close',function(){
  //       	autoAdmin.grid.hideOverlayEditor( $(this).closest('.auto-admin-grid-overlay-editor') );
  //       })

  //   $(':input').first().focus();

    adf.start({});

});