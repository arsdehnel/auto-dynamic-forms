ADF.messages = {
    displayLevels: [
        // 'log',
        'info',
        'debug',
        'warning',
        'error'
    ]
};
ADF.utils = {
    capitalize: function( string ) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    },
    camelize: function( string ) {
        return string.toLowerCase().replace(/[_.-](\w|$)/g, function (_,x) {
            return x.toUpperCase();
        });
    },
    spin: function( targetObj ) {
        targetObj.removeClass('hide').html('').addClass('loading').spin();
    },
    message: function() {

        // var args = Array.slice(arguments);
        var args = Array.prototype.slice.call(arguments);

        // remove first argument
        var level = args.shift();

        // add a prefix item to the logs just to try and be clear where it came from
        args.unshift('[ADF]');

        if( _.indexOf(ADF.messages.displayLevels,level) >= 0 ){

            // TODO: extend this to present errors as modals
            // TODO: allow console command to change alert levels
            console[level](args);

        }

        // TODO: log all messages into "level" specific arrays

//      // make sure our history log is ready
//          autoAdmin.log.history = autoAdmin.log.history || [];   // store logs to an array for reference

//          // output it if this browser supports that
//          if(window.console){
//          console.log( arguments );
//          }

//          // add a datestamp
//          args.push(Date.now());

//          // put it into our history log with the datestamp added
//          autoAdmin.log.history.push(args);

    },

    printObject: function(obj){
        return JSON.stringify(obj,null,'\t').replace(/\n/g,'<br>').replace(/\t/g,'&nbsp;&nbsp;&nbsp;');
    },

}


// window.autoAdmin = window.autoAdmin || {};

// autoAdmin.utils = {



//     spin: function( targetObj ){

//     	targetObj.removeClass('hide').html('').addClass('loading').spin();

//     },

//     pageSpin: function(){

//         this.pageOverlay({'show':true});
//         $('.page-spin').removeClass('hide');
//         this.pageSpinner = new Spinner({length: 60,width: 35, radius: 100}).spin(document.getElementById('page-spin'));

//     },

//     pageSpinStop: function(){

//         this.pageOverlay({'show':false});
//         $('.page-spin').addClass('hide');
//         this.pageSpinner.stop();

//     },

//     pageOverlay: function( args ){

//         if( args.show ){
//             $('.body-overlay').removeClass('hide');
//         }else{
//             $('.body-overlay').addClass('hide');
//         }

//     },

//     renderSelect2: function(){

//         // TODO dynamically determine if user can clear selection
//         // TODO dynamically determine if user cna add new option

//         var settings = {
//             "dropdownAutoWidth" : true,
//             "allowClear" : true,
//             "formatResult" : autoAdmin.utils.select2Template
//         }

//         $.extend( settings, arguments[0] );

//         var select2Obj = settings.select2Obj;

//         delete settings.select2Obj;

//         select2Obj.select2(settings);

//         if( select2Obj.attr('readonly') === "readonly" ){
//             select2Obj.select2("readonly",true);
//         }


//     },

//     select2Template: function( object, container, query ){

//         //make this into a jQ object so we can retrieve the data- attribute data
//         var optObj = $(object.element);

//         //have to do some manual stuff to "convert" this object that we get
//         //into a normal js object that can be used in hour handlebars template
//         //rather than just a plain old js-built template
//         if( object.id === object.text || object.text.length === 0 ){
//             var entryObj = {
//               "value" : object.id,
//               "label" : object.id,
//               "tooltip" : optObj.data('tooltip')
//             }
//         }else{
//             var entryObj = {
//               "value" : object.id,
//               "label" : "<span class='select2-option-value'>"+object.id+"</span><span class='select2-option-label'>"+object.text+"</span>",
//               "tooltip" : optObj.data('tooltip')
//             }
//         }
//         return autoAdmin.templates.inputHelperSelect2Record( entryObj );

//     },



// }
// TODO: svg rendering
var ADF = ADF||{};
ADF.App = Marionette.Application.extend({
  initialize: function(options) {
     ADF.utils.message('log','App Initialized', options);
     var adf = this;
     adf.listenTo(adf,'regionsInitialized',function(){
      // TODO: remove this bullshit
        setTimeout(function(){
            adf.showRegions()
        },200)
    });

   // },1000);
  },
  initRegions: function(){
    var app = this;
    var regions = {};
    $('.adf-region').each(function(){
        var region = $(this);
        var regionData = region.data();
        regionData.regionClass = ADF.utils.capitalize(regionData.adfRegionType)+'Region';
        regionData.elSelector = '#'+$(this).attr('id');
        regionData.regionName = ADF.utils.camelize($(this).attr('id'));

        // create the region
        regions[regionData.regionName] = new ADF[regionData.regionClass](_.extend({el: regionData.elSelector},regionData));
        app.addRegions(regions);
    },app.trigger('regionsInitialized'));
  },
  showRegions: function() {
    _.each(this.getRegions(),function(region){
      region.show();
    })
  },
  findRegion: function( filter ) {
    var regions = this.getRegions();
    return _.find(regions,function(region){
      return region[filter.attribute] === filter.value || region.options[filter.attribute] === filter.value;
    });
  }
});

var adf = new ADF.App({container: '.adf-page'});
adf.on("start", function(options){
    this.initRegions();
});
ADF.Region = Marionette.Region.extend({
    // TODO: create new region for an overlay
    // TODO: overlay region optionally can get data from caller region

    initialize: function(options){
        ADF.utils.message('log','Region Initialized',options);
        this.adfAjaxOnload = ( options.adfAjaxOnload ? options.adfAjaxOnload : false );
    },
    show: function() {
        // TODO: this really shouldn't be in the region object, probably part of the view that we've associated with it...
        if( this.adfAjaxOnload ){
            this.ajax();
        }
    },
    ajax: function( options ){
        var region = this;
        var settings = _.extend({}, options);

        ADF.utils.message('log','Ajax Call',options,settings);

        $.ajax({
            url: ( settings.url ? settings.url : region.options.adfAjaxUrl ),
            type: ( settings.method ? settings.method : "GET" ),
            data: settings.data,
            dataType: "json",
            beforeSend: function(){
                // TODO: resolve issue with this emptying out the target element
                // ADF.utils.spin(region.$el);
            },
            complete: function( jqXHR, textStatus ){

                if( jqXHR.status === 200 ){

                    ADF.utils.message('log','AJAX message: '+jqXHR.responseJSON.message);

                    // this is custom depending on the calling region's type so we send it back
                    region.ajaxSuccessHandler(jqXHR.responseJSON);

                }else if( jqXHR.status === 404 ){

                    ADF.utils.message('error',"Page Not Found\n\nThe ajax calls is being made to a page ("+settings.url+") that could not be found. Probably going to need to get a TA involved to see what is going on here.");

                }else{

                    alert(textStatus+'! Probably going to need to get a TA involved.');
                    console.log('settings',settings);
                    console.log(jqXHR);
                    target.html(jqXHR.responseText);

                }

            }
        })
    }
});

ADF.FormRegion = ADF.Region.extend({
    // TODO: handle being in a dialog
    // TODO: field dependency lookup

    initialize: function( options ) {
        ADF.utils.message('log','FormRegion Initialized', options);
        this._super( options );
    },

    show: function() {

        var formRegion = this;

        formRegion.formView = new ADF.FormView({
            el:formRegion.$el.find('form')[0],
            collection: new ADF.FieldsCollection(),
            childView: ADF.FieldView
        });

        this._super();

    },

    ajaxSuccessHandler: function( xhrJson ) {

        var formView = this.formView;

        if( xhrJson.success === true ){

            if( xhrJson.data.hasOwnProperty('fields') ){

                formView.collection.reset(xhrJson.data.fields);

                // TODO: add select2 renderer as part of the auto-rendering of the Marionette view

                // manually call render for some reason
                // thought that Marionette handled this for us but it wasn't firing so this had to be added
                formView.render();

            }

        }else{

            if( xhrJson.hasOwnProperty('errors') ){
                _.each(xhrJson.errors,function( element, index, array ){
                    alert(element);
                })
            }else{
                alert("Looks like the ajax response wasn't quite what was expected.  Probably need to get a TA involved to help figure it out.");
            }

        }

    }

});
ADF.GridRegion = ADF.Region.extend({
    template: ADF.templates.gridWrapper,
    initialize: function( options ) {
        ADF.utils.message('log','GridRegion Initialized', options);

        var gridRegion = this;

        gridRegion.$el.html(gridRegion.template());
        gridRegion.fieldsCollection = new ADF.FieldsCollection(null,{regionName:gridRegion.options.regionName});

        this._super( options );

    },

    show: function() {

        ADF.utils.message('log','gridRegion Shown');

        var gridRegion = this;
        gridRegion.gridView = new ADF.GridView({
            el:gridRegion.$el.find('.adf-grid-wrapper')[0],
            collection: new ADF.RecordsCollection(null,{regionName:gridRegion.options.regionName}),
            regionName: gridRegion.options.regionName
        })

        this._super();

    },

    ajaxSuccessHandler: function( xhrJson ) {

        var gridRegion = this;

        if( xhrJson.success === true ){

            if( xhrJson.data.hasOwnProperty('fields') ){

                gridRegion.fieldsCollection.reset(xhrJson.data.fields);

            }

            if( xhrJson.data.hasOwnProperty('records') ){

                gridRegion.gridView.collection.reset(xhrJson.data.records);

                // TODO: add select2 renderer as part of the auto-rendering of the Marionette view

                // manually call render for some reason
                // thought that Marionette handled this for us but it wasn't firing so this had to be added
                gridRegion.gridView.render();

            }


        }else{

            if( xhrJson.hasOwnProperty('errors') ){
                _.each(xhrJson.errors,function( element, index, array ){
                    alert(element);
                })
            }else{
                alert("Looks like the ajax response wasn't quite what was expected.  Probably need to get a TA involved to help figure it out.");
            }

        }

    }

});
ADF.DropdownMenuModel = Backbone.Model.extend({
    defaults: {
        buttonLabel: "Menu Name",
        footerOptions: []
    },
    initialize: function( data ){
        ADF.utils.message('log','DropdownMenuModel Initialized', data);
    }
});
ADF.FieldModel = Backbone.Model.extend({

    initialize: function( data ){
        ADF.utils.message('log','FieldModel Initialized', data);

        // do this step-by-step for clarity and maintainability (not to mention debuggability)
        var inputType = this.get('type');
        inputType = ADF.utils.camelize(inputType);
        inputType = ADF.utils.capitalize(inputType);
        inputType = 'inputType'+inputType;

        this.set("inputField",ADF.templates[inputType](this.toJSON()));
        // this.set("regionName",this.collection.regionName);
    }

});
ADF.RecordModel = Backbone.Model.extend({

    initialize: function( data ){
        ADF.utils.message('log','RecordModel Initialized', data);
    }

});

//     initialize: function( opts ){

//         var that = this;

//     },

//     createTplObject: function( args ){

//         var record = this;
//         var fieldsArray = args.fields;
//         var $target = args.target;
//         var createRow = ( args.hasOwnProperty("createRow") && args.createRow );
//         var cellObj = {};
//         var recordObj = {}
//         recordObj.cells = new Array();

//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             cellObj = fieldsArray[i];
//             cellObj.set("currentValue",record.get(fieldsArray[i].get("name")));
//             cellObj.set("inputField",cellObj.render());

//             recordObj.cells.push({'html': autoAdmin.templates.gridCell( cellObj.toJSON() )});

//         }

//         //make sure we have an ID value, even for new rows
//         if( record.get("id") ){
//             recordObj.id = record.get("id");
//             recordObj.rowClass = "current";
//         }else{
//             recordObj.id = 'a' + Math.round( Math.random() * 10000000 );
//             rowClass = "added";
//         }

//         return recordObj;

//     },

//     render: function( args ){

//         var tplObject = this.createTplObject( args );

//         alert('not done');

//         // TODO handle create row argument, etc.

//         // if( createRow ){

//     //         if( !args.hasOwnProperty('adjSibObj') || args.adjSibObj === false ){
//     //             $target.append( autoAdmin.render.hbsTemplate( "autoAdminGridRow", rowObj ) );
//     //         }else{
//     //             adjSibObj.after( autoAdmin.render.hbsTemplate( "autoAdminGridRow", rowObj ) );
//     //         }

//         // }else{

//         //      $target.find('tbody tr#'+recordObj.id).replaceWith(autoAdmin.templates.gridRow( rowObj ) );

//         // }

//     //     $('#'+dataObj.id).find('.select2').each(function(){
//     //         autoAdmin.render.renderSelect2({
//     //             select2Obj : $(this)
//     //         })
//     //     });

//     },

//     save: function( e ){

//         e.preventDefault();

//         console.log('some event');

//     }
ADF.FieldsCollection = Backbone.Collection.extend({

    model: ADF.FieldModel,

    initialize: function( models, options ){
        ADF.utils.message('log','FieldsCollection Initialized', models, options);

        var that = this;

    }

});
ADF.RecordsCollection = Backbone.Collection.extend({

    model: ADF.RecordModel,

    initialize: function( models, options ){
        ADF.utils.message('log','RecordsCollection Initialized', models, options);

        var recordsCollection = this;

        // recordsCollection.regionName = options.regionName;

    }

});
ADF.DropdownMenuView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.dropdownMenu,
    tagName: 'li',
    childView: ADF.DropdownItemView,
    childViewContainer: '.dropdown-menu',
    // baseEvents: {
    //     "click .dropdown-wrapper .dropdown-toggle"     : "dropdownToggle",
    // },
    // customEvents: {},
    // events: function() {
    //     return _.extend({},this.baseEvents,this.customEvents);
    // },
    // model: new ADF.DropdownMenuModel({
    //     buttonLabel: "Menu Name",
    //     wrapClass: "column-selector",
    //     footerOptions: []
    // }),
    initialize: function( options ) {
        ADF.utils.message('log','DropdownMenu Initialized', options );
    }

});
ADF.CellView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.gridCell,
    tagName: 'td',
    initialize: function( options ){
        console.log('[ADF] CellView Initialized', options);
        // this.setElement(this.template(this.model.toJSON()));
        // <td data-column-select-priority="{{fieldPriority}}" data-header-id="{{name}}" class="{{wrapClass}}">
    },
    render: function() {
        this.$el
            .attr('data-column-select-priority',this.model.get('fieldPriority'))
            .attr('data-header-id',this.model.get('name'))
            .addClass(this.model.get('wrapClass'));
        this._super();
    }
});
ADF.ColumnSelectItemView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.dropdownSelectItem,
    tagName: 'li',
    initialize: function( options ){
        ADF.utils.message('log','ColumnSelectItemView Initialized', options);
        // this.model.set('regionName',options.regionName);
    },
    renderOld: function() {
        // TODO: make this use a proper and complete HBS file rather than this weird innerHTML stuff
        this._super();
    }
});
// TODO: get this prototype to work
// ADF.ColumnSelectView = ADF.DropdownMenuView({
ADF.ColumnSelectView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.dropdownMenu,
    tagName: 'li',
    childView: ADF.ColumnSelectItemView,
    childViewContainer: '.dropdown-menu',
    // childViewOptions : function () {
    //     return { regionName: this.regionName };
    // },
    events: {
        // TODO: this should go to the parent prototype
        "click .dropdown-wrapper .dropdown-toggle"     : "dropdownToggle",
        // TODO: create hierarchy of events somehow
        "click .adf-grid-column-group"          : "columnSelect",
        "change .column-selector .dropdown-menu input" : "columnSelect"
    },
    // TODO: this model should go to the parent prototype but something wasn't working with that so it's on the list for later
    model: new ADF.DropdownMenuModel(),
    initialize: function( options ) {
        ADF.utils.message('log','ColumnSelectView Initialized', options );
        this.regionName = options.regionName;
        this.model.set('buttonLabel','Column Select');
        this.model.set('wrapClass','column-selector');
        this.model.get('footerOptions').push({
            href : "#",
            itemClass : "adf-grid-column-group",
            label : "All Columns",
            dataAttributes : [
                {
                    "name" : "column-select-type",
                    "value" : "all"
                }
            ]
        });
        this.model.get('footerOptions').push({
            href : "#",
            itemClass : "adf-grid-column-group",
            label : "Minimum Columns",
            dataAttributes : [
                {
                    "name" : "column-select-type",
                    "value" : "min"
                }
            ]
        });
        this.model.get('footerOptions').push({
            href : "#",
            itemClass : "adf-grid-column-group",
            label : "Default Columns",
            dataAttributes : [
                {
                    "name" : "column-select-type",
                    "value" : "dflt"
                }
            ]
        });
    },
    render: function() {

        // render the main bits
        this.$el.html(this.template(this.model.toJSON()));

        var columnSelect = this;

        // normally would do variables up top but this requires the html() to be created already
        var childContainer = this.$el.find(this.childViewContainer).find('.divider');

        // put the children (the fields) into the drop down but above the divider
        this.collection.each(function(model){

            // TODO: move this to the model initializer
            model.set('regionName',columnSelect.regionName);
            console.debug('columnitem render',model.toJSON());

            if( model.get("fieldPriority") !== 0 ){
                var childView = new columnSelect.childView;
                var headerCell = $('#'+columnSelect.regionName+'--'+model.get("name"));
                if( headerCell.css('display') === 'table-cell' ){
                    model.set('checked',true);
                }
                childContainer.before(childView.template(model.toJSON()))
            }

        })

        return this;
    },
    // TODO: move this to the prototype
    dropdownToggle: function( event ) {

        if( event.target ){

            event.preventDefault();
            var $target = $(event.target);

        }else{      // we're just going to assume it's a jQuery object then

            var $target = event;

        }

        $target.closest('.dropdown-wrapper').find('.dropdown-menu').toggleClass('hide');

    },
    columnSelect: function(e) {

        e.preventDefault();

        var colSelect = this;
        var $target = $(e.target);
        var groupType = $target.attr('data-column-select-type')

        console.log('columnselect triggered',$target,groupType,id);

        if( typeof groupType == 'undefined' ){

            var id = $target.val();
            var cells = $('#'+id+", .adf-grid td[data-header-id="+id+"]");

            console.log('columnselect details',id,cells);

            if( $target.is(':checked') ){
                cells.show();
            }else{
                cells.hide();
            }

        }else{

            switch( groupType ){

                case "all":
                    $target.closest('.dropdown-wrapper').find('.dropdown-menu :input').not(':checked').trigger('click');
                    break;

                case "min":
                    $target.closest('.dropdown-wrapper').find('.dropdown-menu :input').each(function(){
                        var inputObj = $(this);
                        var priority = parseInt( $('#'+inputObj.val()).attr('data-column-select-priority'), 10 );
                        if( ( inputObj.is(':checked') && priority > 1 ) || ( inputObj.is(':not(:checked)') && priority <= 1 ) ){
                            inputObj.trigger('click');
                        }
                    })
                    break;

                case "dflt":
                    var dropdownMenu = $target.closest('.dropdown-wrapper').find('.dropdown-menu');
                    $('.adf-grid th, .adf-grid td').css("display", "");
                    $('.adf-grid th').each(function(){

                        var inputObj = dropdownMenu.find(':input[value='+$(this).attr('id')+']');

                        //check the visibility of this header which is now based on the media queries
                        if( $(this).css('display') === 'table-cell' && inputObj.is(':not(:checked)') ){

                            inputObj.trigger('click');

                        }else if( $(this).css('display') === 'none' && inputObj.is(':checked') ){

                            inputObj.trigger('click');

                        }

                    })
                    break;

            }

            colSelect.dropdownToggle( $target.closest('.dropdown-wrapper').find('.dropdown-toggle') );

        }

    }

});
ADF.FieldView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.formRow,
    initialize: function( options ){
        ADF.utils.message('log','FieldView Initialized', options);
    },
    render: function(){
        this.$el.html(this.template(this.model.toJSON()));
        return this;
    }
});
ADF.FormView = Marionette.CollectionView.extend({

    initialize: function( options ) {
        ADF.utils.message('log','[ADF] FormView Initialized', options );
    },

    events: {
        'change :input'                                   : 'submitParentForm',
        'submitAjax'                                      : 'submitFormAjax'
    },

    submitParentForm: function( event ) {

        $(event.target).closest('form').trigger('submitAjax');

    },

    submitFormAjax: function( event ) {

        var $form = $(event.target);
        var action = $form.attr('action');
        var region = adf.findRegion({
            attribute : 'el',
            value : action
        });

        if( $(action).size() > 0 ){

            ADF.utils.message('log','Found something to load into');

            region.ajax();

            // $.ajax({
            //     url: opts.url,
            //     type: opts.method,
            //     data: opts.data,
            //     dataType: ( opts.resultType === "html" ? "html" : "json" ),
            //     beforeSend: function(){
            //         autoAdmin.utils.spin(opts.target);
            //     },
            //     complete: function( jqXHR, textStatus ){

            //         if( jqXHR.status === 200 ){

            //             if( opts.resultType === 'html' ){

            //                 that.responseText = jqXHR.responseText;

            //             }else{

            //                 console.log('[autoAdmin] AJAX message: '+jqXHR.responseJSON.message);

            //                 if( jqXHR.responseJSON.success === true ){

            //                     if( jqXHR.responseJSON.data.hasOwnProperty('records') ){

            //                         that.recordsColl = new autoAdmin.RecordsCollection();
            //                         that.recordsColl.add(jqXHR.responseJSON.data.records);

            //                     }

            //                     if( jqXHR.responseJSON.data.hasOwnProperty('fields') ){

            //                         that.fieldsColl = new autoAdmin.FieldsCollection();
            //                         that.fieldsColl.add(jqXHR.responseJSON.data.fields);

            //                     }


            //                 }else{

            //                     if( jqXHR.responseJSON.hasOwnProperty('errors') ){
            //                         _.each(jqXHR.responseJSON.errors,function( element, index, array ){
            //                             alert(element);
            //                         })
            //                     }else{
            //                         alert("Looks like the ajax response wasn't quite what was expected from "+opts.url+".  Probably need to get a TA involved.");
            //                     }

            //                 }

            //             }

            //             that.trigger('ajaxLoaded');

            //         }else if( jqXHR.status === 404 ){

            //             alert("Page Not Found\n\nThe ajax calls is being made to a page ("+opts.url+") that could not be found. Probably going to need to get a TA involved to see what is going on here.");

            //         }else{

            //             alert(textStatus+'! Probably going to need to get a TA involved.');
            //             console.log('opts',opts);
            //             console.log(jqXHR);
            //             target.html(jqXHR.responseText);

            //         }

            //     }
            // })

        }else{
            ADF.utils.message('error','Trying to load ajax but destination element could not be found on the page');
        }

    }
});

//     render: function( opts ){

//         var that = this;
//         var $form = opts.target;
//         var fieldsArray = opts.ajaxView.fieldsColl.models;
//         var fieldObj = {};

//         $form.removeClass('loading').html('');

//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             fieldObj = {};

//             fieldObj = fieldsArray[i];

//             fieldObj.set("inputField", fieldsArray[i].render() );

//             $form.append(autoAdmin.templates.formField( fieldObj.toJSON() ))

//         }

//         $form.find('.select2').each(function(){
//             autoAdmin.utils.renderSelect2({
//                 select2Obj : $(this)
//             })
//         })

//     },

// });
ADF.GridView = Backbone.Marionette.CompositeView.extend({
    // TODO: finish grid lookup
    // TODO: add record action
    // TODO: grid-row actions
    // TODO: grid-row messaging
    // TODO: overlay triggering
    // TODO: overlay template adjusted to handle array of data with format/delimiter from data-supl-info attribute

    className: 'adf-grid',
    tagName: 'table',
    childView: ADF.RecordView,
    childViewContainer: "tbody",
    template: ADF.templates.gridTable,
    initialize: function( options ) {
        ADF.utils.message('log','GridView Initialized', options );
        var gridView = this;
        gridView.regionName = options.regionName;
        var region = adf._regionManager.get(gridView.regionName);
        gridView.$el.html(gridView.template({}));

        gridView.headersView = new ADF.HeadersView({
            el: gridView.$el.find('thead')[0],
            collection: region.fieldsCollection,
            regionName: gridView.regionName
        });

        gridView.columnSelect = new ADF.ColumnSelectView({
            el: gridView.$el.find('.adf-grid-actions')[0],
            collection: region.fieldsCollection,
            regionName: gridView.regionName
        })

    },
    render: function() {
        var gridView = this;
        gridView.headersView.render();
        gridView.columnSelect.render();
        var childContainer = this.$el.find(this.childViewContainer);
        gridView.collection.each(function(model) {

            // var childView = new gridView.childView({model:model});
            var childView = new ADF.RecordView();
            childContainer.before(childView.template(model.toJSON()))

            console.log('yay for grid collection',childView.render());
        })
    }
});

// autoAdmin.GridView = autoAdmin.PageView.extend({

//     render: function( opts ){

//         var gridView = this;
//         var $target = opts.target;
//         var fieldsArray = opts.ajaxView.fieldsColl.models;
//         var recordsArray = opts.ajaxView.recordsColl.models;
//         var gridObj = {};

//         gridObj.headers = new Array();
//         gridObj.colSelectCols = new Array();
//         gridObj.records = new Array();

//         // COLUMNS
//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             fieldsArray[i].set("colIndex",i);
//             fieldsArray[i].set("gridRow",true);

//             gridObj.headers[i] = { 'html' : autoAdmin.templates.gridHeaderCell( fieldsArray[i].toJSON() ) };

//             if( fieldsArray[i].get("columnSelectPriority") != 0 ){

//                 // TODO: set the checked attribute if this is going to be visible

//                 gridObj.colSelectCols.push({'html' : autoAdmin.templates.dropdownSelectItem( $.extend( fieldsArray[i].toJSON(), {parent:"column-selector"} ) ) });

//             }

//         }

//         // put those fields into records
//         for ( var j = 0; j < recordsArray.length; j++ ) {

//             gridObj.records.push({
//                 'html' : autoAdmin.templates.gridRow( recordsArray[j].createTplObject({fields : fieldsArray}))
//             });

//         }

//         gridObj.colSelect = gridView.renderColumnSelector( gridObj.colSelectCols );

//         // TODO grid actions

//         $target.html( autoAdmin.templates.gridWrapper( gridObj ) );

//         gridView.refreshFilters( $target, fieldsArray );

//         $target.find('.select2').each(function(){
//             autoAdmin.utils.renderSelect2({
//                 select2Obj : $(this)
//             })
//         })

//     },

//     refreshFilters: function( $target, fieldsArray ){

//         var gridView = this;
//         var rows = $target.find('tbody tr');
//         var val;
//         var fieldName;
//         var field;
//         var values = new Array();

//         // go through each column
//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             field = fieldsArray[i];

//             fieldName = field.get("name");

//             if( fieldName === 'actions' ){
//                 continue;
//             }

//             // reset for each column
//             values = {}

//             rows.each(function(){

//                 // cache it
//                 var inputElement = $(this).find('td').eq(i).find(':input[name='+fieldName+']');

//                 // BUG select2 values being accumulated into filters not working properly
//                 val = ( inputElement.val() ? inputElement.val() : inputElement.select2("val") );

//                 if( val && val.length > 0 ){
//                     values[val] = val;
//                 }

//             })

//             //add these to the main columns array
//             if( _.size(values) > 0 ){
//                 field.set("currentValues",values);
//             }

//             // refresh the filter
//             gridView.refreshFilterOptions( $target, field );

//         }

//     },

//     refreshFilterOptions: function( $target, field ){

//         var th = $target.find('thead tr th').eq(field.get("colIndex"));
//         var tmpltObj = {};
//         var dropdownObj = {
//             wrapClass : "grid-header-filter",
//             footerOptions : [
//                 {
//                     href : "#",
//                     itemClass : "grid-header-filter-clear",
//                     label : "Clear Filters"
//                 }
//             ]
//         }

//         //remove all filter data
//         th.find('.dropdown-wrapper').remove();
//         th.append( autoAdmin.templates.dropdownMenu( dropdownObj ) );

//         //only attempt to do something if there are values in there
//         if( _.size(field.get("currentValues")) > 0 ){

//             th.addClass('has-filter').find('.icon-filter').removeClass('hide')

//             for( var value in field.get("currentValues") ){

//                 tmpltObj.name = value;
//                 tmpltObj.parent = field.get("name");
//                 if( field.get('data') && field.get('data').length > 0 ){

//                     for( var rec in field.get('data').data ){

//                         if( field.get("data")[rec].value == value ){

//                             tmpltObj.label = ( field.get("data")[rec].hasOwnProperty('label') ? field.get("data")[rec].label : field.get("data")[rec].value );
//                             break;

//                         }

//                     }

//                 }else{

//                     tmpltObj.label = value;

//                 }

//                 th.find('.dropdown-menu .divider').before( autoAdmin.templates.dropdownSelectItem( tmpltObj ) );

//             }

//         }else{

//             th.find('.icon-filter').addClass('hide');

//         }

//     },

// });
ADF.HeaderView = Backbone.Marionette.ItemView.extend({
    template: ADF.templates.gridHeaderCell,
    tagName: 'th',
    initialize: function( options ){
        ADF.utils.message('log','HeaderView Initialized', options);
        this.model.set('colIndex',this.model.collection.indexOf(this.model))
        this.model.set('regionName',options.regionName);
    },
    render: function() {
        // TODO: use hbs template rather than all this silly JS
        this.$el
            .attr('data-column-select-priority',this.model.get('fieldPriority'))
            .attr('id',this.model.get('regionName') + '--' + this.model.get('name'))
            .attr('data-column-index',this.model.get('colIndex'))
            .addClass(this.model.get('wrapClass'));
        if( this.model.get('tooltip') ){
            this.$el.addClass('has-tooltip');
        }
        // return this.template(this.model.toJSON());
        this._super();
    }
});
ADF.HeadersView = Backbone.Marionette.CollectionView.extend({
    template: ADF.templates.gridRow,
    tagName: 'tr',
    childView: ADF.HeaderView,
    childViewOptions : function () {
        return { regionName: this.regionName };
    },
    initialize: function( options ) {
        ADF.utils.message('log','HeadersView Initialized', options );
        this.regionName = options.regionName;
    }

});
// 'use strict';
// window.autoAdmin = window.autoAdmin || {};

// autoAdmin.PageView = Backbone.View.extend({

//     el: ".auto-admin-page",

//     initialize: function(opts){
//         var that = this;

//         this.onloadAjax();

//         this.listenTo( Backbone, 'onloadAjaxCheck', function () {
//             this.onloadAjax();
//         }, this );
//     },

//     events: {
//         // AJAX
//         "change .submit-on-change"                     : "submitParentFormAjax",
//         "click .load-on-click"                         : "loadOnClickAjax",
//         "click .submit-parent-form-ajax"               : "submitParentFormAjax",

//         // TODO apply filters action
//     },

//     submitAjax: function( ajaxObj ) {

//         var that = this;
//         this.ajaxViews = new Array();

//         switch( ajaxObj.resultType ){
//             case "form":
//                 that.ajaxViews.push(new autoAdmin.FormView(ajaxObj));
//                 break;
//             case "grid":
//                 that.ajaxViews.push(new autoAdmin.GridView(ajaxObj));
//                 break;
//             case "html":
//                 that.ajaxViews.push(new autoAdmin.HtmlView(ajaxObj));
//                 break;
//             default:
//                 alert('Unexpected result type: '+resultType+'.  Probably going to need to a get a TA involved.');
//                 break;

//         }

//     },

//     onloadAjax: function(){

//         var pageView = this;

//         //there might be more than one on the page when the page loads (or when a partial loads)
//         $('body').find('.auto-admin-onload-ajax').each(function(){

//             var triggerObj = $(this);
//             var target = triggerObj;
//             var ajaxObj = {};

//             if( triggerObj.attr('data-onload-ajax-target-id') != "" ){
//                 target = $('#'+triggerObj.attr('data-onload-ajax-target-id'));
//             }

//             ajaxObj.url = triggerObj.attr('data-onload-ajax-url');
//             ajaxObj.method = "GET";
//             ajaxObj.data = "";
//             ajaxObj.target = target;
//             ajaxObj.resultType = triggerObj.attr('data-result-type');

//             triggerObj.removeClass('auto-admin-onload-ajax');

//             pageView.submitAjax( ajaxObj );

//         })

//     },

//     formSubmitAjax: function( $trigger ){

//         // e.preventDefault();     //just to make sure we don't submit anything

//         var pageView = this;
//         var $form = $trigger.is('form') ? $trigger : $trigger.closest('form');
//         var ajaxObj = {};

//         ajaxObj.url = $form.attr('action');
//         ajaxObj.method = $form.attr('method');
//         ajaxObj.data = $form.serializeObject();
//         ajaxObj.target = $('#'+$form.attr('data-target-id'));
//         ajaxObj.resultType = $form.attr('data-result-type');

//         pageView.submitAjax( ajaxObj );

//     },

//     submitParentFormAjax: function(e) {

//         e.preventDefault();
//         this.formSubmitAjax( $(e.target) );

//     },

//     loadOnClickAjax: function(e) {

//         // don't want to follow the link
//         e.preventDefault();

//         var pageView = this;
//         var linkObj = $(e.target);
//         var ajaxObj = {};

//         ajaxObj.url = linkObj.attr('href');
//         ajaxObj.method = "get";
//         ajaxObj.data = "";
//         ajaxObj.target = $('#'+linkObj.attr('data-load-on-click-target-id'));
//         ajaxObj.resultType = linkObj.attr('data-result-type');

//         pageView.submitAjax( ajaxObj );

//     },

// });
ADF.RecordView = Backbone.Marionette.CompositeView.extend({
    template: ADF.templates.gridRow,
    tagName: 'tr',
    childView: ADF.CellView,
    // childViewContainer: 'tr',
    initialize: function( options ) {
        ADF.utils.message('log','RecordView Initialized', options );

        // this.setElement(this.template(this.model.toJSON()));

        this.collection = adf.findRegion({
            attribute : 'regionName',
            value : this.model.collection.regionName
        }).fieldsCollection;

    },
    render: function() {
        // TODO: figure out a way to properly use a template that actually as a <tr> in it
        // <tr id="{{regionName}}--{{id}}" class="adf-record {{rowClass}}"></tr>
        this.$el
            .attr('id',this.model.get('regionName') + '--' + this.model.get('id'))
            .addClass('adf-record '+this.model.get('rowClass'));
        // this._super();
        return this._super();
    }
});

// <tr id="{{tableId}}--{{id}}" class="adf-record {{rowClass}}">
//     {{#each cells}}
//         {{{html}}}
//     {{/each}}
// </tr>

// 'use strict';
// window.autoAdmin = window.autoAdmin || {};

// autoAdmin.RecordView = autoAdmin.PageView.extend({

//     className: "auto-admin-record",

//     el: ".auto-admin-record",

//     initialize: function(opts){
//         var that = this;

//         console.log('[autoAdmin] RecordView initialized', opts);

//     },

//     events: {
//         // ACTIONS
//         "click .btn-save"                     : "save"
//     },

//     createTplObject: function( args ){

//         var record = this;
//         var fieldsArray = args.fields;
//         var $target = args.target;
//         var createRow = ( args.hasOwnProperty("createRow") && args.createRow );
//         var cellObj = {};
//         var recordObj = {}
//         recordObj.cells = new Array();

//         for ( var i = 0; i < fieldsArray.length; i++ ) {

//             cellObj = fieldsArray[i];
//             cellObj.set("currentValue",record.get(fieldsArray[i].get("name")));
//             cellObj.set("inputField",cellObj.render());

//             recordObj.cells.push({'html': autoAdmin.templates.gridCell( cellObj.toJSON() )});

//         }

//         //make sure we have an ID value, even for new rows
//         if( record.get("id") ){
//             recordObj.id = record.get("id");
//             recordObj.rowClass = "current";
//         }else{
//             recordObj.id = 'a' + Math.round( Math.random() * 10000000 );
//             rowClass = "added";
//         }

//         return recordObj;

//     },

//     render: function( args ){

//         var tplObject = this.createTplObject( args );

//         alert('not done');

//         // TODO handle create row argument, etc.

//         // if( createRow ){

//     //         if( !args.hasOwnProperty('adjSibObj') || args.adjSibObj === false ){
//     //             $target.append( autoAdmin.render.hbsTemplate( "autoAdminGridRow", rowObj ) );
//     //         }else{
//     //             adjSibObj.after( autoAdmin.render.hbsTemplate( "autoAdminGridRow", rowObj ) );
//     //         }

//         // }else{

//         //      $target.find('tbody tr#'+recordObj.id).replaceWith(autoAdmin.templates.gridRow( rowObj ) );

//         // }

//     //     $('#'+dataObj.id).find('.select2').each(function(){
//     //         autoAdmin.render.renderSelect2({
//     //             select2Obj : $(this)
//     //         })
//     //     });

//     },

//     save: function( e ){

//         e.preventDefault();

//         console.log('some event');

//     }

// });
$(function(){

	// $.event.props.push('dataTransfer');

  //   $('body')
  //       .on('click','.refresh-menu',function(e){
  //       	e.preventDefault();
  //       	autoAdmin.core.refreshTemplates(true);
  //       })
  //       .on('click', '.auto-admin-grid-overlay-editor .display-value',function(){
  //       	autoAdmin.grid.showOverlayEditor( $(this).parent() );
  //       })
  //       .on('click', '.auto-admin-grid-overlay-editor .close',function(){
  //       	autoAdmin.grid.hideOverlayEditor( $(this).closest('.auto-admin-grid-overlay-editor') );
  //       })

  //   $('.select2').select2().each(function(){
		// autoAdmin.render.renderSelect2({
		// 	select2Obj : $(this)
		// })
  //   });

  //   $(':input').first().focus();

    var options = {
        something: "some value",
        another: "#some-selector"
    };

    adf.start(options);

    // window.autoAdmin = window.autoAdmin || {};

    // var autoAdminInit = new autoAdmin.PageView;

})